<!DOCTYPE html>
<html lang="th" data-theme="pastel">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Aysoot - Easy Costing</title>
    
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.6.0/dist/full.min.css" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.10/dayjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.10/locale/th.min.js"></script>

    <style>
        /* --- แก้ปัญหาเลื่อนไม่ติด/กดไม่ติด แบบถาวร --- */
        body {
            font-family: 'Prompt', sans-serif;
            min-height: 100vh;
            overflow-x: hidden;
            overflow-y: auto; /* บังคับให้เลื่อนได้ */
            -webkit-overflow-scrolling: touch;
            padding-bottom: 100px; /* เว้นที่ให้เมนูล่าง */
            
            /* ฝังลายพื้นหลังลงไปเลย ไม่ต้องมี div แยก */
            background-color: #f8fafc;
            background-image: radial-gradient(#cbd5e1 1px, transparent 1px);
            background-size: 20px 20px;
        }

        /* Top Bar - Glass Effect */
        .glass-header {
            position: fixed; top: 0; left: 0; right: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(8px);
            border-bottom: 1px solid #e2e8f0;
            z-index: 50; /* อยู่บนสุดเสมอ */
            height: 60px;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 16px;
        }

        /* Bottom Navigation */
        .btm-nav {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: #ffffff;
            border-top: 1px solid #e2e8f0;
            height: 70px; /* สูงขึ้นนิดนึงให้กดง่าย */
            z-index: 50;
            padding-bottom: env(safe-area-inset-bottom);
            display: flex; justify-content: space-around; align-items: center;
        }

        .nav-btn {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            width: 100%; height: 100%; color: #94a3b8;
            transition: all 0.2s; background: none; border: none;
        }
        .nav-btn.active { color: #f97316; }
        .nav-btn i { font-size: 1.4rem; margin-bottom: 2px; }
        .nav-btn span { font-size: 0.7rem; }

        /* ปุ่มบวกตรงกลาง */
        .add-btn-wrapper {
            position: relative; top: -25px;
        }
        .add-btn {
            width: 60px; height: 60px;
            background: #1e293b; color: white;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.8rem;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            border: 4px solid #fff;
        }

        /* Card Style */
        .card-recipe {
            background: white; border-radius: 16px;
            padding: 16px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.02);
            border: 1px solid #f1f5f9;
            margin-bottom: 12px;
            cursor: pointer;
            transition: transform 0.1s;
        }
        .card-recipe:active { transform: scale(0.98); }

        /* SweetAlert ปรับให้สวย */
        div:where(.swal2-container) { z-index: 9999 !important; }
        .swal2-popup { border-radius: 20px !important; }
        .swal2-confirm { background-color: #22c55e !important; box-shadow: none !important; }
        .swal2-cancel { background-color: #ef4444 !important; }
    </style>
</head>
<body>

    <div class="glass-header">
        <div class="flex items-center gap-2">
            <i class="fa-solid fa-calculator text-orange-500 text-xl"></i>
            <span class="font-bold text-lg text-slate-700">Aysoot Costing</span>
        </div>
        <div id="header-status" class="text-xs text-slate-400">...</div>
    </div>

    <main id="app-root" class="container mx-auto px-4 pt-20 max-w-lg">
        </main>

    <div id="bottom-nav" class="btm-nav hidden">
        <button onclick="app.navTo('home')" id="nav-home" class="nav-btn">
            <i class="fa-solid fa-house"></i>
            <span>หน้าแรก</span>
        </button>
        
        <button onclick="app.navTo('search')" id="nav-search" class="nav-btn">
            <i class="fa-solid fa-magnifying-glass"></i>
            <span>ค้นหา</span>
        </button>

        <div class="add-btn-wrapper">
            <button onclick="app.openCreateModal()" class="add-btn">
                <i class="fa-solid fa-plus"></i>
            </button>
        </div>

        <button onclick="app.navTo('profile')" id="nav-profile" class="nav-btn">
            <i class="fa-solid fa-user"></i>
            <span>โปรไฟล์</span>
        </button>
    </div>

    <dialog id="modal_auth" class="modal modal-bottom sm:modal-middle">
        <div class="modal-box bg-white rounded-t-3xl p-8">
            <h3 class="text-2xl font-bold text-center mb-6">เข้าสู่ระบบ</h3>
            <form id="auth-form" class="space-y-4">
                <div id="field-name" class="hidden">
                    <input type="text" id="inp-name" class="input input-bordered w-full rounded-xl bg-slate-50" placeholder="ชื่อเชฟ">
                </div>
                <input type="email" id="inp-email" class="input input-bordered w-full rounded-xl bg-slate-50" placeholder="อีเมล" required>
                <input type="password" id="inp-pass" class="input input-bordered w-full rounded-xl bg-slate-50" placeholder="รหัสผ่าน" required>
                <button type="submit" class="btn bg-slate-800 text-white w-full rounded-xl text-lg shadow-md">ยืนยัน</button>
            </form>
            <div class="text-center mt-4">
                <button type="button" onclick="app.toggleAuth()" class="text-orange-500 text-sm underline">สมัครสมาชิก / เข้าสู่ระบบ</button>
            </div>
        </div>
    </dialog>

    <dialog id="modal_create" class="modal">
        <div class="modal-box w-full h-full max-h-full sm:max-h-[85vh] sm:rounded-3xl bg-white p-0 flex flex-col">
            <div class="px-4 py-3 border-b flex justify-between items-center bg-white sticky top-0 z-10">
                <button class="btn btn-sm btn-ghost" onclick="modal_create.close()">ยกเลิก</button>
                <h3 class="font-bold">จดสูตร & ต้นทุน</h3>
                <button onclick="app.confirmSave()" class="btn btn-sm bg-green-500 text-white rounded-full px-4 border-none">บันทึก</button>
            </div>
            
            <div class="flex-1 overflow-y-auto p-4 bg-slate-50 pb-24">
                <div class="bg-white p-4 rounded-xl shadow-sm mb-4">
                    <label class="text-xs text-slate-400 font-bold uppercase">ชื่อเมนู</label>
                    <input type="text" id="recipe-name" class="input input-lg w-full font-bold text-xl px-0 border-none focus:outline-none placeholder-slate-300" placeholder="ระบุชื่อเมนู...">
                </div>

                <div class="bg-white p-4 rounded-xl shadow-sm">
                    <div class="flex justify-between items-center mb-4">
                        <span class="font-bold text-orange-600"><i class="fa-solid fa-coins"></i> รายการต้นทุน</span>
                    </div>
                    
                    <div class="grid grid-cols-12 gap-2 text-xs text-slate-400 mb-2 px-1">
                        <div class="col-span-6">วัตถุดิบ</div>
                        <div class="col-span-3 text-center">ปริมาณ</div>
                        <div class="col-span-3 text-right">ราคา(฿)</div>
                    </div>
                    
                    <div id="ing-list" class="space-y-3"></div>
                    
                    <button onclick="app.addIng()" class="btn btn-sm btn-outline w-full mt-4 border-dashed border-slate-300 text-slate-400">
                        + เพิ่มรายการ
                    </button>
                    
                    <div class="divider my-2"></div>
                    <div class="flex justify-between items-center font-bold text-lg">
                        <span>รวมต้นทุน:</span>
                        <span id="total-cost-display" class="text-green-600">0 ฿</span>
                    </div>
                </div>
            </div>
        </div>
    </dialog>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, query, where, getDocs, deleteDoc, updateDoc, arrayUnion, arrayRemove, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDVS3zsJSeqOs5Wwpkj-DNbN1vhfc2_3LE",
            authDomain: "aysoot.firebaseapp.com",
            projectId: "aysoot",
            storageBucket: "aysoot.firebasestorage.app",
            messagingSenderId: "56310141842",
            appId: "1:56310141842:web:a08f702a98a39a0eb7274b"
        };

        const appFire = initializeApp(firebaseConfig);
        const auth = getAuth(appFire);
        const db = getFirestore(appFire);

        window.state = { user: null, mode: 'login' };

        window.app = {
            init: () => {
                onAuthStateChanged(auth, u => {
                    state.user = u;
                    if(u) {
                        document.getElementById('bottom-nav').classList.remove('hidden');
                        document.getElementById('bottom-nav').classList.add('flex');
                        document.getElementById('header-status').textContent = '';
                        app.navTo('home');
                    } else {
                        document.getElementById('bottom-nav').classList.add('hidden');
                        document.getElementById('bottom-nav').classList.remove('flex');
                        app.renderLogin();
                    }
                });
            },

            navTo: (page) => {
                // Update active button
                document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                const btn = document.getElementById(`nav-${page}`);
                if(btn) btn.classList.add('active');

                // Render content
                if(page === 'home') app.renderHome();
                else if(page === 'search') app.renderSearch();
                else if(page === 'profile') app.renderProfile();
            },

            // --- 1. Home ---
            renderHome: async () => {
                const root = document.getElementById('app-root');
                root.innerHTML = `<div class="text-center pt-20"><span class="loading loading-dots loading-lg text-slate-400"></span></div>`;
                
                try {
                    const q = query(collection(db, "recipes"), where("ownerId", "==", state.user.uid));
                    const snap = await getDocs(q);
                    const recipes = [];
                    snap.forEach(d => recipes.push({ id: d.id, ...d.data() }));
                    
                    recipes.sort((a, b) => b.createdAt?.seconds - a.createdAt?.seconds);

                    if(recipes.length === 0) {
                        root.innerHTML = `
                            <div class="flex flex-col items-center justify-center pt-24 text-slate-300">
                                <i class="fa-solid fa-clipboard-list text-6xl mb-4"></i>
                                <p>ยังไม่มีรายการต้นทุน</p>
                                <button onclick="app.openCreateModal()" class="btn btn-sm btn-outline mt-4">เริ่มจดสูตรแรก</button>
                            </div>`;
                        return;
                    }

                    root.innerHTML = `
                        <h2 class="font-bold text-xl mb-4 px-1 text-slate-700">รายการต้นทุนของฉัน</h2>
                        <div class="pb-24">
                            ${recipes.map(r => {
                                const total = r.ingredients.reduce((s,i)=>s+(parseFloat(i.price)||0),0);
                                return `
                                <div onclick="app.viewRecipe('${r.id}')" class="card-recipe flex justify-between items-center">
                                    <div class="flex items-center gap-3">
                                        <div class="w-10 h-10 rounded-full bg-orange-100 text-orange-600 flex items-center justify-center font-bold">
                                            ${r.name.charAt(0)}
                                        </div>
                                        <div>
                                            <div class="font-bold text-slate-700">${r.name}</div>
                                            <div class="text-xs text-slate-400">CODE: ${r.id}</div>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <div class="font-bold text-green-600">${total.toLocaleString()} ฿</div>
                                        <div class="text-[10px] text-slate-400">ต้นทุน</div>
                                    </div>
                                </div>
                            `}).join('')}
                        </div>
                    `;
                } catch(e) { console.error(e); }
            },

            // --- 2. Search ---
            renderSearch: () => {
                document.getElementById('app-root').innerHTML = `
                    <div class="flex flex-col items-center pt-10">
                        <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-100 w-full text-center">
                            <i class="fa-solid fa-qrcode text-4xl text-slate-300 mb-4"></i>
                            <h2 class="font-bold text-lg mb-2">ค้นหาจากรหัสสูตร</h2>
                            <div class="flex gap-2">
                                <input id="search-code" type="text" class="input input-bordered w-full uppercase text-center font-bold" placeholder="ABCD1">
                                <button onclick="app.doSearch()" class="btn bg-slate-800 text-white"><i class="fa-solid fa-search"></i></button>
                            </div>
                        </div>
                    </div>
                `;
            },
            doSearch: () => {
                const code = document.getElementById('search-code').value.trim();
                if(code) app.viewRecipe(code.toUpperCase());
            },

            // --- 3. Profile (New) ---
            renderProfile: () => {
                const u = state.user;
                document.getElementById('app-root').innerHTML = `
                    <div class="pt-10 flex flex-col items-center">
                        <div class="avatar mb-4">
                            <div class="w-24 rounded-full border-4 border-white shadow-lg">
                                <img src="https://ui-avatars.com/api/?name=${u.displayName}&size=200&background=random" />
                            </div>
                        </div>
                        <h2 class="text-2xl font-bold text-slate-800">${u.displayName}</h2>
                        <p class="text-slate-500 text-sm mb-8">${u.email}</p>

                        <div class="w-full bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                            <button onclick="app.logout()" class="w-full text-left p-4 text-red-500 hover:bg-red-50 flex justify-between items-center">
                                <span><i class="fa-solid fa-arrow-right-from-bracket mr-2"></i> ออกจากระบบ</span>
                            </button>
                        </div>
                        <p class="mt-8 text-xs text-slate-300">Aysoot Costing V.Lite</p>
                    </div>
                `;
            },

            // --- View Logic (No Steps) ---
            viewRecipe: async (id) => {
                const root = document.getElementById('app-root');
                root.innerHTML = `<div class="text-center pt-20"><span class="loading loading-spinner text-orange-500"></span></div>`;
                
                const snap = await getDoc(doc(db, "recipes", id));
                if(!snap.exists()) return Swal.fire('ไม่พบข้อมูล', '', 'error').then(()=>app.navTo('home'));
                
                const d = snap.data();
                const total = d.ingredients.reduce((s,i)=>s+(parseFloat(i.price)||0),0);
                const isOwner = state.user && d.ownerId === state.user.uid;

                root.innerHTML = `
                    <div class="pb-24">
                        <button onclick="app.navTo('home')" class="btn btn-sm btn-ghost pl-0 mb-2 text-slate-400"><i class="fa-solid fa-chevron-left"></i> กลับ</button>
                        
                        <div class="bg-white rounded-2xl p-5 shadow-sm border border-slate-100 mb-4 relative">
                            <h1 class="text-2xl font-bold text-slate-800">${d.name}</h1>
                            <div class="text-xs text-slate-400 mt-1">CODE: ${id} | โดย ${d.ownerName}</div>
                            ${isOwner ? `<button onclick="app.deleteRecipe('${id}')" class="absolute top-4 right-4 text-red-400 btn btn-sm btn-circle btn-ghost"><i class="fa-solid fa-trash"></i></button>` : ''}
                        </div>

                        <div class="bg-slate-800 text-white rounded-2xl p-6 shadow-lg mb-4 text-center">
                            <div class="text-slate-400 text-sm">ต้นทุนสุทธิ (Total Cost)</div>
                            <div class="text-4xl font-bold text-green-400 my-1">${total.toLocaleString()} ฿</div>
                            <div class="text-slate-500 text-xs">แนะนำขาย: ${Math.ceil(total * 2.5)} ฿</div>
                        </div>

                        <div class="bg-white rounded-2xl border border-slate-100 overflow-hidden">
                            <div class="bg-orange-50 px-4 py-2 text-orange-700 font-bold text-sm border-b border-orange-100">
                                รายละเอียดวัตถุดิบ
                            </div>
                            <table class="table w-full text-sm">
                                <thead><tr class="text-slate-400 font-normal"><th>รายการ</th><th class="text-center">จำนวน</th><th class="text-right">ราคา</th></tr></thead>
                                <tbody>
                                    ${d.ingredients.map(i => `
                                        <tr class="border-slate-50">
                                            <td class="font-medium">${i.name}</td>
                                            <td class="text-center text-slate-500">${i.qty}</td>
                                            <td class="text-right font-bold">${i.price}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            },

            // --- Modal Create ---
            openCreateModal: () => {
                document.getElementById('recipe-name').value = '';
                document.getElementById('ing-list').innerHTML = '';
                app.addIng(); // Add default one row
                app.calcTotalCost();
                document.getElementById('modal_create').showModal();
            },
            
            addIng: () => {
                const div = document.createElement('div');
                div.className = "grid grid-cols-12 gap-2 mb-2";
                div.innerHTML = `
                    <div class="col-span-6"><input type="text" class="ing-name input input-bordered input-sm w-full rounded-lg" placeholder="ชื่อ"></div>
                    <div class="col-span-3"><input type="text" class="ing-qty input input-bordered input-sm w-full text-center rounded-lg" placeholder="จน."></div>
                    <div class="col-span-3"><input type="number" oninput="app.calcTotalCost()" class="ing-price input input-bordered input-sm w-full text-right rounded-lg" placeholder="0"></div>
                `;
                document.getElementById('ing-list').appendChild(div);
            },
            
            calcTotalCost: () => {
                let total = 0;
                document.querySelectorAll('.ing-price').forEach(el => total += parseFloat(el.value) || 0);
                document.getElementById('total-cost-display').innerText = total.toLocaleString() + ' ฿';
                return total;
            },

            confirmSave: () => {
                const name = document.getElementById('recipe-name').value;
                const ings = [];
                document.querySelectorAll('#ing-list > div').forEach(r => {
                    const n = r.querySelector('.ing-name').value;
                    const q = r.querySelector('.ing-qty').value;
                    const p = r.querySelector('.ing-price').value;
                    if(n) ings.push({name:n, qty:q, price:p});
                });

                if(!name || ings.length===0) return Swal.fire('ข้อมูลไม่ครบ', 'กรุณาใส่ชื่อเมนูและวัตถุดิบ', 'warning');

                Swal.fire({
                    title: 'บันทึกต้นทุน?',
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'บันทึกเลย',
                    cancelButtonText: 'แก้ไข',
                    confirmButtonColor: '#22c55e',
                    cancelButtonColor: '#d1d5db'
                }).then(async r => {
                    if(r.isConfirmed) {
                        try {
                            const code = Math.random().toString(36).substring(2,7).toUpperCase();
                            await setDoc(doc(db, "recipes", code), {
                                name, ingredients: ings,
                                ownerId: state.user.uid, ownerName: state.user.displayName,
                                createdAt: serverTimestamp(), isBest: false
                            });
                            document.getElementById('modal_create').close();
                            app.navTo('home');
                            Swal.fire('เรียบร้อย', 'บันทึกข้อมูลแล้ว', 'success');
                        } catch(e) { Swal.fire('Error', e.message, 'error'); }
                    }
                });
            },

            deleteRecipe: (id) => {
                Swal.fire({title:'ลบรายการนี้?', text:'กู้คืนไม่ได้นะครับ', icon:'warning', showCancelButton:true, confirmButtonColor:'#ef4444', confirmButtonText:'ลบ'}).then(async r=>{
                    if(r.isConfirmed) { await deleteDoc(doc(db, "recipes", id)); app.navTo('home'); }
                });
            },

            // --- Login/Auth ---
            renderLogin: () => {
                document.getElementById('app-root').innerHTML = `
                    <div class="flex flex-col items-center justify-center pt-32">
                        <div class="w-20 h-20 bg-slate-800 rounded-full flex items-center justify-center text-white text-4xl mb-6 shadow-xl">
                            <i class="fa-solid fa-calculator"></i>
                        </div>
                        <h1 class="text-2xl font-bold text-slate-800">Aysoot Costing</h1>
                        <p class="text-slate-400 mb-8">ระบบคำนวณต้นทุนอาหาร</p>
                        <button onclick="app.openAuth('login')" class="btn bg-orange-500 hover:bg-orange-600 text-white w-48 rounded-full shadow-lg border-none text-lg">เริ่มใช้งาน</button>
                    </div>
                `;
            },
            openAuth: (mode) => {
                state.mode = mode;
                document.getElementById('modal_auth').showModal();
                if(mode==='register') document.getElementById('field-name').classList.remove('hidden');
                else document.getElementById('field-name').classList.add('hidden');
            },
            toggleAuth: () => app.openAuth(state.mode==='login'?'register':'login'),
            logout: () => signOut(auth)
        };

        document.getElementById('auth-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('inp-email').value;
            const pass = document.getElementById('inp-pass').value;
            const name = document.getElementById('inp-name').value;
            try {
                if(state.mode === 'register') {
                    const res = await createUserWithEmailAndPassword(auth, email, pass);
                    await updateProfile(res.user, { displayName: name });
                } else await signInWithEmailAndPassword(auth, email, pass);
                document.getElementById('modal_auth').close();
            } catch(e) { Swal.fire('Login Error', e.message, 'error'); }
        });

        app.init();
    </script>
</body>
</html>
