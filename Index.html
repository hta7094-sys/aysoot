<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Aysoot Elite - Professional Costing</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        /* --- System Core --- */
        :root {
            --primary: #2563eb;
            --bg-body: #f8fafc;
            --nav-height: 80px;
        }

        body {
            font-family: 'Prompt', sans-serif;
            background-color: var(--bg-body);
            color: #1e293b;
            /* ป้องกันการดึงหน้าจอ (Overscroll) */
            overscroll-behavior-y: none;
            /* ป้องกัน Double Tap Zoom */
            touch-action: manipulation; 
            -webkit-tap-highlight-color: transparent;
            user-select: none; /* ป้องกันการคลุมดำโดยไม่ตั้งใจ */
        }

        /* Input ให้พิมพ์ได้ */
        input, textarea { user-select: text; }

        /* Scrollbar ซ่อนให้เนียน */
        ::-webkit-scrollbar { width: 0px; background: transparent; }

        /* Animations */
        .fade-in { animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Custom UI Elements */
        .glass-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.5);
        }

        .input-std {
            width: 100%; padding: 14px 16px;
            background: #fff; border: 1px solid #e2e8f0;
            border-radius: 16px; font-size: 15px;
            transition: all 0.2s; outline: none;
            -webkit-appearance: none;
        }
        .input-std:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1);
        }

        /* Navigation Bar */
        .nav-bar {
            position: fixed; bottom: 0; left: 0; width: 100%;
            height: var(--nav-height); background: white;
            border-top: 1px solid #f1f5f9;
            display: grid; grid-template-columns: repeat(4, 1fr);
            padding-bottom: env(safe-area-inset-bottom);
            z-index: 50; box-shadow: 0 -10px 40px rgba(0,0,0,0.03);
        }
        .nav-item {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: #94a3b8; transition: 0.2s; cursor: pointer;
        }
        .nav-item.active { color: var(--primary); }
        .nav-item.active i { transform: translateY(-3px); }
        .nav-icon { font-size: 1.4rem; margin-bottom: 4px; }
        .nav-text { font-size: 0.65rem; font-weight: 600; letter-spacing: 0.5px; }

        /* Floating Add Button */
        .nav-add-btn {
            background: var(--primary); color: white;
            width: 50px; height: 50px; border-radius: 20px;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 8px 20px rgba(37, 99, 235, 0.4);
            transform: translateY(-5px);
        }

        /* Page Controller */
        .page { display: none; padding: 80px 20px 100px 20px; }
        .page.active { display: block; }
        
        /* Fixed Header */
        .app-header {
            position: fixed; top: 0; left: 0; width: 100%; height: 65px;
            background: rgba(255,255,255,0.95); backdrop-filter: blur(8px);
            z-index: 40; display: flex; align-items: center; justify-content: space-between;
            padding: 0 24px; border-bottom: 1px solid #f1f5f9;
        }
    </style>
</head>
<body>

    <header class="app-header">
        <div class="flex items-center gap-3">
            <div class="w-9 h-9 bg-gradient-to-tr from-blue-600 to-indigo-500 rounded-xl flex items-center justify-center text-white shadow-lg shadow-blue-200">
                <i class="fa-solid fa-layer-group"></i>
            </div>
            <div>
                <h1 class="font-bold text-lg text-slate-800 leading-none">Aysoot</h1>
                <span class="text-[10px] text-slate-400 font-medium tracking-wider">ELITE EDITION</span>
            </div>
        </div>
        <div id="user-pill" class="flex items-center gap-2 bg-slate-100 px-3 py-1.5 rounded-full">
            <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
            <span id="header-username" class="text-xs font-bold text-slate-600">Guest</span>
        </div>
    </header>

    <main class="container mx-auto max-w-md">

        <div id="pg-dashboard" class="page active fade-in">
            <div class="mb-6">
                <h2 class="text-2xl font-bold text-slate-800">ภาพรวมธุรกิจ</h2>
                <p class="text-slate-400 text-sm">สถิติและข้อมูลสูตรของคุณ</p>
            </div>

            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="bg-white p-5 rounded-3xl shadow-sm border border-slate-100 relative overflow-hidden group">
                    <div class="absolute right-[-10px] top-[-10px] w-20 h-20 bg-blue-50 rounded-full group-hover:scale-110 transition"></div>
                    <div class="relative z-10">
                        <i class="fa-solid fa-book-open text-blue-500 text-2xl mb-2"></i>
                        <p class="text-slate-400 text-xs font-bold uppercase">สูตรทั้งหมด</p>
                        <p id="stat-count" class="text-3xl font-bold text-slate-800">0</p>
                    </div>
                </div>
                <div class="bg-white p-5 rounded-3xl shadow-sm border border-slate-100 relative overflow-hidden group">
                    <div class="absolute right-[-10px] top-[-10px] w-20 h-20 bg-green-50 rounded-full group-hover:scale-110 transition"></div>
                    <div class="relative z-10">
                        <i class="fa-solid fa-coins text-green-500 text-2xl mb-2"></i>
                        <p class="text-slate-400 text-xs font-bold uppercase">มูลค่ารวม</p>
                        <p id="stat-cost" class="text-2xl font-bold text-slate-800">0</p>
                    </div>
                </div>
            </div>

            <div class="bg-gradient-to-br from-slate-800 to-slate-900 rounded-[28px] p-6 text-white shadow-xl shadow-slate-200 relative overflow-hidden">
                <div class="absolute top-0 right-0 w-32 h-32 bg-white opacity-5 rounded-full blur-3xl transform translate-x-10 -translate-y-10"></div>
                
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <span class="bg-yellow-400/20 text-yellow-300 text-[10px] font-bold px-3 py-1 rounded-full border border-yellow-400/30">
                            <i class="fa-solid fa-crown mr-1"></i> BEST SELLER
                        </span>
                    </div>
                </div>

                <div id="dash-best-content">
                    <p class="text-slate-400 text-sm">ยังไม่มีการตั้งค่าสูตรแนะนำ</p>
                </div>
            </div>
            
            <div class="mt-6 text-center">
                <button onclick="App.nav('list')" class="text-sm text-slate-400 font-medium hover:text-blue-500 transition">
                    ดูรายการทั้งหมด <i class="fa-solid fa-arrow-right ml-1"></i>
                </button>
            </div>
        </div>

        <div id="pg-search" class="page fade-in">
            <div class="bg-white rounded-[32px] p-8 shadow-xl shadow-slate-100 text-center border border-slate-50 mt-10">
                <div class="w-20 h-20 bg-blue-50 rounded-full flex items-center justify-center mx-auto mb-6 text-blue-500 text-3xl">
                    <i class="fa-solid fa-magnifying-glass"></i>
                </div>
                <h2 class="text-xl font-bold text-slate-800 mb-2">ค้นหาสูตรลับ</h2>
                <p class="text-slate-400 text-sm mb-6">กรอกรหัสสูตร 6 หลัก เพื่อดูข้อมูล</p>
                
                <input type="text" id="search-code" maxlength="6" class="w-full bg-slate-100 border-none rounded-2xl py-4 text-center text-2xl font-bold tracking-[0.5em] uppercase mb-4 focus:ring-2 focus:ring-blue-500 focus:bg-white transition placeholder-slate-300" placeholder="CODE">
                
                <button onclick="App.searchRecipe()" class="w-full bg-slate-800 text-white py-4 rounded-xl font-bold shadow-lg active:scale-95 transition">
                    ค้นหาทันที
                </button>
            </div>
        </div>

        <div id="pg-list" class="page fade-in">
            <h2 class="text-xl font-bold mb-6">รายการสูตรของคุณ</h2>
            <div id="list-container" class="space-y-4 pb-20"></div>
        </div>

        <div id="pg-view" class="page fade-in">
            <div id="view-mode">
                <button onclick="App.nav('list')" class="mb-4 text-slate-500 text-sm font-bold flex items-center gap-2">
                    <i class="fa-solid fa-chevron-left"></i> ย้อนกลับ
                </button>

                <div class="bg-white rounded-[32px] p-8 shadow-sm border border-slate-100 mb-4 text-center relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-blue-400 to-indigo-500"></div>
                    <h1 id="view-name" class="text-3xl font-bold text-slate-800 mb-2 mt-2">Title</h1>
                    <div class="text-sm text-slate-400 mb-6 flex justify-center gap-3">
                        <span id="view-owner"><i class="fa-solid fa-user"></i> Owner</span>
                        <span id="view-id" class="font-mono bg-slate-100 px-2 rounded">#ID</span>
                    </div>
                    
                    <div class="text-4xl font-bold text-green-500 mb-2" id="view-cost">0 ฿</div>
                    <p class="text-xs text-slate-400 uppercase tracking-widest font-bold">ต้นทุนรวมสุทธิ</p>
                </div>

                <div class="bg-white rounded-3xl p-6 shadow-sm border border-slate-100 mb-6">
                    <h3 class="font-bold text-slate-700 mb-4 flex items-center gap-2"><i class="fa-solid fa-basket-shopping text-orange-500"></i> วัตถุดิบ</h3>
                    <ul id="view-ing-list" class="space-y-3 text-sm"></ul>
                </div>

                <div id="view-actions" class="hidden">
                    <button onclick="App.confirmEdit()" class="w-full bg-blue-600 text-white py-4 rounded-2xl font-bold shadow-lg shadow-blue-200 mb-3 active:scale-95 transition">
                        <i class="fa-solid fa-pen-to-square mr-2"></i> แก้ไขสูตรนี้
                    </button>
                    <button onclick="App.confirmDelete()" class="w-full bg-red-50 text-red-500 py-4 rounded-2xl font-bold hover:bg-red-100 transition">
                        ลบสูตร
                    </button>
                </div>
            </div>

            <div id="edit-mode" class="hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold" id="form-header">สร้างสูตรใหม่</h2>
                    <button onclick="App.cancelEdit()" class="text-slate-400 text-sm font-medium">ยกเลิก</button>
                </div>

                <div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-100 mb-6">
                    <label class="label-text">ชื่อเมนู</label>
                    <input type="text" id="inp-name" class="input-std font-bold text-lg mb-4" placeholder="เช่น กะเพราหมูสับ">
                    
                    <div class="flex items-center gap-3 bg-slate-50 p-3 rounded-xl border border-slate-100">
                        <input type="checkbox" id="inp-best" class="w-5 h-5 accent-blue-600">
                        <label for="inp-best" class="text-sm font-medium text-slate-600">ตั้งเป็นเมนูแนะนำ (Dashboard)</label>
                    </div>
                </div>

                <div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-100 mb-20">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-slate-700">รายการวัตถุดิบ</h3>
                        <span id="form-total" class="text-green-600 font-bold text-lg">0.00</span>
                    </div>

                    <div id="form-ing-container" class="space-y-3 mb-4"></div>

                    <button onclick="App.addIngRow()" class="w-full py-3 border-2 border-dashed border-slate-200 rounded-xl text-slate-400 font-bold hover:border-blue-400 hover:text-blue-500 transition mb-6">
                        + เพิ่มรายการ
                    </button>

                    <button onclick="App.saveRecipe()" class="w-full bg-slate-800 text-white py-4 rounded-xl font-bold text-lg shadow-xl active:scale-95 transition">
                        บันทึกข้อมูล
                    </button>
                </div>
            </div>
        </div>

    </main>

    <nav class="nav-bar">
        <div class="nav-item active" onclick="App.nav('dashboard')" id="nav-dashboard">
            <i class="fa-solid fa-chart-pie nav-icon"></i>
            <span class="nav-text">ภาพรวม</span>
        </div>
        <div class="nav-item" onclick="App.nav('search')" id="nav-search">
            <i class="fa-solid fa-search nav-icon"></i>
            <span class="nav-text">ค้นหา</span>
        </div>
        <div class="nav-item" onclick="App.openCreate()" id="nav-create">
            <div class="nav-add-btn">
                <i class="fa-solid fa-plus text-xl"></i>
            </div>
        </div>
        <div class="nav-item" onclick="App.nav('list')" id="nav-list">
            <i class="fa-solid fa-book nav-icon"></i>
            <span class="nav-text">สูตรของฉัน</span>
        </div>
    </nav>

    <div id="auth-modal" class="fixed inset-0 bg-slate-900/60 z-[100] hidden items-center justify-center backdrop-blur-sm p-5">
        <div class="bg-white w-full max-w-sm rounded-[32px] p-8 shadow-2xl relative">
            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-slate-800 rounded-2xl mx-auto flex items-center justify-center text-white text-2xl mb-4 shadow-lg">
                    <i class="fa-solid fa-fingerprint"></i>
                </div>
                <h2 class="text-2xl font-bold text-slate-800">เข้าสู่ระบบ</h2>
                <p class="text-slate-400 text-sm">Aysoot Elite System</p>
            </div>
            <form onsubmit="App.handleAuth(event)" class="space-y-4">
                <input type="email" id="auth-email" class="input-std bg-slate-50" placeholder="อีเมล" required>
                <input type="password" id="auth-pass" class="input-std bg-slate-50" placeholder="รหัสผ่าน" required>
                <button type="submit" class="w-full bg-blue-600 text-white py-4 rounded-xl font-bold text-lg shadow-lg shadow-blue-200 mt-2">
                    เริ่มต้นใช้งาน
                </button>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, query, where, getDocs, deleteDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Firebase Config
        const appFire = initializeApp({
            apiKey: "AIzaSyDVS3zsJSeqOs5Wwpkj-DNbN1vhfc2_3LE",
            authDomain: "aysoot.firebaseapp.com",
            projectId: "aysoot",
            storageBucket: "aysoot.firebasestorage.app",
            messagingSenderId: "56310141842",
            appId: "1:56310141842:web:a08f702a98a39a0eb7274b"
        });
        const auth = getAuth(appFire);
        const db = getFirestore(appFire);

        // Global State
        let currentUser = null;
        let currentRecipeId = null; // For Edit Mode
        let isEditMode = false;
        let recipesData = [];

        window.App = {
            init: () => {
                onAuthStateChanged(auth, u => {
                    currentUser = u;
                    if(u) {
                        document.getElementById('auth-modal').style.display = 'none';
                        document.getElementById('header-username').innerText = u.displayName || u.email.split('@')[0];
                        App.fetchData();
                    } else {
                        document.getElementById('auth-modal').style.display = 'flex';
                    }
                });
            },

            // --- Navigation ---
            nav: (page) => {
                // Reset States
                isEditMode = false;
                currentRecipeId = null;
                document.getElementById('edit-mode').classList.add('hidden');
                document.getElementById('view-mode').classList.remove('hidden');

                document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
                document.getElementById(`pg-${page}`).classList.add('active');

                // Update Bottom Bar
                document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                const navItem = document.getElementById(`nav-${page}`);
                if(navItem) navItem.classList.add('active');
                
                if(page === 'dashboard') App.renderDashboard();
                if(page === 'list') App.renderList();
            },

            // --- Dashboard Logic ---
            fetchData: async () => {
                if(!currentUser) return;
                const q = query(collection(db, "recipes"), where("ownerId", "==", currentUser.uid));
                const snap = await getDocs(q);
                recipesData = [];
                snap.forEach(d => recipesData.push({id: d.id, ...d.data()}));
                recipesData.sort((a,b) => (b.createdAt?.seconds||0) - (a.createdAt?.seconds||0));
                App.renderDashboard();
            },

            renderDashboard: () => {
                let totalCost = 0;
                let best = null;
                recipesData.forEach(r => {
                    totalCost += parseFloat(r.totalCost || 0);
                    if(r.isBest) best = r;
                });

                document.getElementById('stat-count').innerText = recipesData.length;
                document.getElementById('stat-cost').innerText = totalCost.toLocaleString();
                
                const bestEl = document.getElementById('dash-best-content');
                if(best) {
                    bestEl.innerHTML = `
                        <h3 class="text-2xl font-bold mb-1">${best.name}</h3>
                        <div class="flex items-center gap-3">
                            <span class="text-green-400 font-bold text-xl">${parseFloat(best.totalCost).toLocaleString()} ฿</span>
                            <span class="text-slate-500 text-sm">/ หน่วย</span>
                        </div>
                    `;
                } else {
                    bestEl.innerHTML = `<p class="text-slate-400 text-sm mt-2">ยังไม่มีการตั้งค่าสูตรแนะนำ</p>`;
                }
            },

            // --- List & Search Logic ---
            renderList: () => {
                const con = document.getElementById('list-container');
                con.innerHTML = '';
                if(recipesData.length === 0) {
                    con.innerHTML = `<div class="text-center text-slate-400 mt-10">ยังไม่มีรายการสูตร</div>`;
                    return;
                }
                recipesData.forEach(r => {
                    const el = document.createElement('div');
                    el.className = "bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex justify-between items-center active:bg-slate-50 transition cursor-pointer";
                    el.onclick = () => App.viewRecipe(r.id, r);
                    el.innerHTML = `
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-lg ${r.isBest?'bg-yellow-100 text-yellow-600':'bg-slate-100 text-slate-400'} flex items-center justify-center font-bold">
                                ${r.name.charAt(0)}
                            </div>
                            <div>
                                <h4 class="font-bold text-slate-800">${r.name}</h4>
                                <span class="text-[10px] text-slate-400">ID: ${r.id}</span>
                            </div>
                        </div>
                        <span class="font-bold text-green-600">${parseFloat(r.totalCost).toLocaleString()} ฿</span>
                    `;
                    con.appendChild(el);
                });
            },

            searchRecipe: async () => {
                const code = document.getElementById('search-code').value.trim();
                if(code.length < 2) return Swal.fire('แจ้งเตือน', 'กรุณากรอกรหัส', 'warning');
                
                try {
                    Swal.showLoading();
                    const snap = await getDoc(doc(db, "recipes", code));
                    Swal.close();
                    
                    if(snap.exists()) {
                        App.viewRecipe(code, snap.data());
                    } else {
                        Swal.fire('ไม่พบข้อมูล', 'รหัสสูตรไม่ถูกต้อง', 'error');
                    }
                } catch(e) { Swal.fire('Error', e.message, 'error'); }
            },

            // --- View & Edit System ---
            viewRecipe: (id, data) => {
                // Populate View
                document.getElementById('view-name').innerText = data.name;
                document.getElementById('view-id').innerText = "#" + id;
                document.getElementById('view-cost').innerText = parseFloat(data.totalCost).toLocaleString() + " ฿";
                document.getElementById('view-owner').innerHTML = `<i class="fa-solid fa-user-circle"></i> ${data.ownerName || 'Unknown'}`;
                
                const ul = document.getElementById('view-ing-list');
                ul.innerHTML = '';
                data.ingredients.forEach(i => {
                    ul.innerHTML += `
                        <li class="flex justify-between py-2 border-b border-slate-50 last:border-0">
                            <span class="text-slate-600">${i.name} (${i.qty})</span>
                            <span class="font-bold text-slate-800">${i.price}</span>
                        </li>
                    `;
                });

                // Show/Hide Edit Actions
                const isOwner = currentUser && currentUser.uid === data.ownerId;
                const actions = document.getElementById('view-actions');
                if(isOwner) {
                    actions.classList.remove('hidden');
                    // Store for edit
                    currentRecipeId = id;
                } else {
                    actions.classList.add('hidden');
                    currentRecipeId = null;
                }

                // Switch Page
                App.nav('view');
            },

            confirmEdit: () => {
                Swal.fire({
                    title: 'แก้ไขสูตรนี้?',
                    text: "การเปลี่ยนแปลงจะถูกบันทึกทับข้อมูลเดิม",
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'ใช่, แก้ไขเลย',
                    cancelButtonText: 'ยกเลิก',
                    confirmButtonColor: '#2563eb'
                }).then((result) => {
                    if (result.isConfirmed) {
                        App.loadEditor(currentRecipeId);
                    }
                });
            },

            confirmDelete: () => {
                Swal.fire({
                    title: 'ยืนยันการลบ',
                    text: "ไม่สามารถกู้คืนได้",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'ลบข้อมูล',
                    confirmButtonColor: '#ef4444'
                }).then(async (res) => {
                    if(res.isConfirmed) {
                        await deleteDoc(doc(db, "recipes", currentRecipeId));
                        App.fetchData();
                        App.nav('list');
                        Swal.fire('Deleted!', '', 'success');
                    }
                });
            },

            // --- Editor Logic ---
            openCreate: () => {
                App.nav('view'); // Go to view page container
                document.getElementById('view-mode').classList.add('hidden');
                document.getElementById('edit-mode').classList.remove('hidden');
                
                // Clear Form
                currentRecipeId = null;
                document.getElementById('form-header').innerText = "สร้างสูตรใหม่";
                document.getElementById('inp-name').value = "";
                document.getElementById('inp-best').checked = false;
                document.getElementById('form-ing-container').innerHTML = "";
                document.getElementById('form-total').innerText = "0.00";
                App.addIngRow();
            },

            loadEditor: (id) => {
                const r = recipesData.find(x => x.id === id);
                if(!r) return;

                document.getElementById('view-mode').classList.add('hidden');
                document.getElementById('edit-mode').classList.remove('hidden');
                
                document.getElementById('form-header').innerText = "แก้ไขสูตร";
                document.getElementById('inp-name').value = r.name;
                document.getElementById('inp-best').checked = r.isBest || false;
                
                const con = document.getElementById('form-ing-container');
                con.innerHTML = "";
                r.ingredients.forEach(i => App.addIngRow(i));
                App.calcFormTotal();
            },

            cancelEdit: () => {
                if(currentRecipeId) {
                    // Back to View Mode
                    document.getElementById('edit-mode').classList.add('hidden');
                    document.getElementById('view-mode').classList.remove('hidden');
                } else {
                    // Back to Dashboard if creating
                    App.nav('dashboard');
                }
            },

            addIngRow: (data = null) => {
                const div = document.createElement('div');
                div.className = "flex gap-2 items-center ing-row fade-in";
                div.innerHTML = `
                    <div class="flex-1"><input type="text" class="input-std py-3 text-sm ing-name" placeholder="ชื่อวัตถุดิบ" value="${data?.name||''}"></div>
                    <div class="w-20"><input type="text" class="input-std py-3 text-sm text-center ing-qty" placeholder="จำนวน" value="${data?.qty||''}"></div>
                    <div class="w-24"><input type="number" class="input-std py-3 text-sm text-right font-bold ing-price" placeholder="ราคา" oninput="App.calcFormTotal()" value="${data?.price||''}"></div>
                    <button onclick="this.parentElement.remove(); App.calcFormTotal()" class="text-slate-300 hover:text-red-500 px-2"><i class="fa-solid fa-xmark"></i></button>
                `;
                document.getElementById('form-ing-container').appendChild(div);
            },

            calcFormTotal: () => {
                let sum = 0;
                document.querySelectorAll('.ing-price').forEach(el => sum += parseFloat(el.value) || 0);
                document.getElementById('form-total').innerText = sum.toLocaleString(undefined, {minimumFractionDigits:2});
                return sum;
            },

            saveRecipe: async () => {
                const name = document.getElementById('inp-name').value.trim();
                const isBest = document.getElementById('inp-best').checked;
                const ings = [];
                document.querySelectorAll('.ing-row').forEach(row => {
                    const n = row.querySelector('.ing-name').value.trim();
                    const q = row.querySelector('.ing-qty').value.trim();
                    const p = row.querySelector('.ing-price').value.trim();
                    if(n) ings.push({name:n, qty:q, price:p});
                });

                if(!name || ings.length === 0) return Swal.fire('ข้อมูลไม่ครบ', 'กรุณาใส่ชื่อและวัตถุดิบ', 'warning');

                const totalCost = App.calcFormTotal();
                const payload = {
                    name, ingredients: ings, isBest, totalCost,
                    ownerId: currentUser.uid,
                    ownerName: currentUser.displayName,
                    updatedAt: serverTimestamp()
                };

                try {
                    Swal.showLoading();
                    if(currentRecipeId) {
                        // Update
                        await updateDoc(doc(db, "recipes", currentRecipeId), payload);
                    } else {
                        // Create
                        const newId = Math.random().toString(36).substring(2, 8).toUpperCase();
                        payload.createdAt = serverTimestamp();
                        await setDoc(doc(db, "recipes", newId), payload);
                    }
                    Swal.fire({ icon: 'success', title: 'บันทึกสำเร็จ', timer: 1500, showConfirmButton: false });
                    App.fetchData();
                    App.nav('list');
                } catch(e) { Swal.fire('Error', e.message, 'error'); }
            },

            handleAuth: async (e) => {
                e.preventDefault();
                const email = document.getElementById('auth-email').value;
                const pass = document.getElementById('auth-pass').value;
                try {
                    await signInWithEmailAndPassword(auth, email, pass);
                } catch(err) { Swal.fire('เข้าสู่ระบบไม่สำเร็จ', err.message, 'error'); }
            }
        };

        App.init();
    </script>
</body>
</html>
