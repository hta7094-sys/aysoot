<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aysoot - บันทึกสูตร เเมะลี่</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Kanit', 'sans-serif'] },
                    colors: {
                        chef: { 50: '#fff7ed', 100: '#ffedd5', 500: '#f97316', 600: '#ea580c', 900: '#7c2d12' }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-image: url('https://images.unsplash.com/photo-1495195134817-aeb325a55b65?q=80&w=2076&auto=format&fit=crop');
            background-size: cover;
            background-attachment: fixed;
            background-position: center;
        }
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
        }
        .fade-enter { animation: fadeIn 0.4s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #f97316; border-radius: 4px; }
    </style>
</head>
<body class="min-h-screen text-gray-800 antialiased">

    <nav class="glass-panel sticky top-0 z-50 px-6 py-4 mb-8">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center gap-2 cursor-pointer" onclick="app.renderHome()">
                <div class="bg-chef-500 text-white w-10 h-10 rounded-full flex items-center justify-center text-xl shadow-lg">
                    <i class="fas fa-utensils"></i>
                </div>
                <h1 class="text-2xl font-bold text-chef-600 tracking-tight">Aysoot</h1>
            </div>
            
            <div id="nav-menu" class="hidden md:flex gap-6 items-center font-medium">
                <button onclick="app.renderHome()" class="hover:text-chef-600 transition">หน้าแรก</button>
                <button onclick="app.renderCompare()" class="hover:text-chef-600 transition">เปรียบเทียบสูตร</button>
                <div id="auth-buttons">
                    </div>
            </div>
        </div>
    </nav>

    <main id="app-container" class="container mx-auto px-4 pb-20 fade-enter max-w-5xl">
        </main>

    <datalist id="globalIngredients">
        <option value="เกลือสมุทร">
        <option value="เกลือหิมาลัย">
        <option value="น้ำตาลมะพร้าว">
        <option value="น้ำตาลทรายแดง">
        <option value="แป้งสาลีอเนกประสงค์">
        <option value="แป้งเค้ก">
        <option value="เนยจืด (Unsalted Butter)">
        <option value="เนยเค็ม (Salted Butter)">
        <option value="วิปปิ้งครีม">
        <option value="น้ำปลาแท้">
        <option value="ซอสหอยนางรม">
        <option value="พริกไทยดำป่น">
        <option value="ออริกาโน่">
        <option value="โรสแมรี่">
        <option value="ชีสมอสซาเรลล่า">
    </datalist>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, query, where, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDVS3zsJSeqOs5Wwpkj-DNbN1vhfc2_3LE",
            authDomain: "aysoot.firebaseapp.com",
            projectId: "aysoot",
            storageBucket: "aysoot.firebasestorage.app",
            messagingSenderId: "56310141842",
            appId: "1:56310141842:web:a08f702a98a39a0eb7274b",
            measurementId: "G-SCDYFZ7TLP"
        };

        const fbApp = initializeApp(firebaseConfig);
        const auth = getAuth(fbApp);
        const db = getFirestore(fbApp);

        // --- State Management ---
        const state = {
            user: null,
            currentView: 'home'
        };

        // --- UI Renders ---
        const ui = {
            login: () => `
                <div class="max-w-md mx-auto glass-panel p-8 rounded-2xl text-center">
                    <h2 class="text-3xl font-bold text-chef-600 mb-2">ยินดีต้อนรับ</h2>
                    <p class="text-gray-500 mb-6">เข้าสู่ระบบเพื่อบันทึกสูตรลับของคุณ</p>
                    <form onsubmit="app.handleAuth(event, 'login')" class="space-y-4">
                        <input type="email" name="email" placeholder="อีเมล" class="w-full p-3 rounded-lg border focus:ring-2 focus:ring-chef-500 outline-none bg-white/50" required>
                        <input type="password" name="password" placeholder="รหัสผ่าน" class="w-full p-3 rounded-lg border focus:ring-2 focus:ring-chef-500 outline-none bg-white/50" required>
                        <button class="w-full bg-gradient-to-r from-chef-500 to-chef-600 text-white py-3 rounded-lg font-bold shadow-lg hover:shadow-xl transition transform hover:-translate-y-1">เข้าสู่ระบบ</button>
                    </form>
                    <p class="mt-4 text-sm">ยังไม่มีบัญชี? <button onclick="app.renderRegister()" class="text-chef-600 font-bold hover:underline">สมัครสมาชิก</button></p>
                </div>
            `,
            register: () => `
                <div class="max-w-md mx-auto glass-panel p-8 rounded-2xl text-center">
                    <h2 class="text-3xl font-bold text-chef-600 mb-2">สมัครสมาชิก</h2>
                    <p class="text-gray-500 mb-6">สร้างบัญชีเพื่อเริ่มเป็นเชฟ</p>
                    <form onsubmit="app.handleAuth(event, 'register')" class="space-y-4">
                        <input type="email" name="email" placeholder="อีเมล" class="w-full p-3 rounded-lg border focus:ring-2 focus:ring-chef-500 outline-none bg-white/50" required>
                        <input type="password" name="password" placeholder="รหัสผ่าน (6 ตัวขึ้นไป)" class="w-full p-3 rounded-lg border focus:ring-2 focus:ring-chef-500 outline-none bg-white/50" required>
                        <button class="w-full bg-chef-600 text-white py-3 rounded-lg font-bold shadow-lg">สมัครสมาชิก</button>
                    </form>
                    <p class="mt-4 text-sm">มีบัญชีแล้ว? <button onclick="app.renderLogin()" class="text-chef-600 font-bold hover:underline">เข้าสู่ระบบ</button></p>
                </div>
            `,
            dashboard: (recipes) => `
                <div class="grid lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-1">
                        <div class="glass-panel p-6 rounded-2xl sticky top-24">
                            <h3 class="text-xl font-bold mb-4 flex items-center gap-2"><i class="fas fa-plus-circle text-chef-500"></i> สร้างสูตรใหม่</h3>
                            <div class="space-y-3">
                                <input id="newRecipeName" type="text" placeholder="ชื่อเมนูอาหาร/ขนม" class="w-full p-3 rounded-lg border border-gray-200 focus:ring-2 focus:ring-chef-500 outline-none">
                                <textarea id="newRecipeDesc" rows="3" placeholder="คำบรรยายสั้นๆ หรือ วิธีทำ" class="w-full p-3 rounded-lg border border-gray-200 focus:ring-2 focus:ring-chef-500 outline-none"></textarea>
                                
                                <div class="bg-orange-50 p-3 rounded-lg border border-orange-100">
                                    <label class="text-xs font-bold text-gray-500 uppercase">ส่วนผสม</label>
                                    <div id="ingredient-inputs" class="space-y-2 mt-2"></div>
                                    <button onclick="app.addIngredientRow()" class="mt-2 text-xs bg-white border border-gray-300 px-2 py-1 rounded hover:bg-gray-50">+ เพิ่มส่วนผสม</button>
                                </div>

                                <button onclick="app.saveRecipe()" class="w-full bg-chef-600 hover:bg-chef-900 text-white py-3 rounded-lg font-bold shadow transition">บันทึกสูตร</button>
                            </div>
                        </div>
                    </div>

                    <div class="lg:col-span-2 space-y-6">
                        <div class="flex justify-between items-end">
                            <h2 class="text-3xl font-bold text-gray-800">สูตรของฉัน</h2>
                            <span class="text-sm text-gray-500">ทั้งหมด ${recipes.length} สูตร</span>
                        </div>
                        ${recipes.length === 0 ? '<div class="text-center py-10 text-gray-400 glass-panel rounded-xl">ยังไม่มีสูตร เริ่มสร้างเลย!</div>' : ''}
                        ${recipes.map(r => ui.recipeCard(r, true)).join('')}
                    </div>
                </div>
            `,
            homeGuest: () => `
                <div class="text-center py-16">
                    <h1 class="text-5xl md:text-6xl font-bold text-white mb-6 drop-shadow-lg">ค้นพบรสชาติที่ใช่</h1>
                    <p class="text-xl text-white/90 mb-8 max-w-2xl mx-auto drop-shadow-md">แหล่งรวมสูตรอาหารและขนมจากทั่วโลก บันทึกสูตรลับของคุณและแบ่งปันผ่านรหัสลับ</p>
                    
                    <div class="max-w-xl mx-auto glass-panel p-2 rounded-full flex shadow-2xl transform hover:scale-105 transition duration-300">
                        <input id="guestSearchCode" type="text" placeholder="กรอกรหัสสูตร (เช่น EYR590)" class="flex-1 bg-transparent p-4 outline-none text-lg font-medium placeholder-gray-400">
                        <button onclick="app.searchRecipeGuest()" class="bg-chef-500 hover:bg-chef-600 text-white px-8 rounded-full font-bold text-lg transition">ค้นหา</button>
                    </div>
                </div>
                <div id="guest-result" class="mt-8 max-w-2xl mx-auto"></div>
            `,
            compare: () => `
                <div class="glass-panel p-8 rounded-2xl min-h-[600px]">
                    <h2 class="text-3xl font-bold text-center mb-8 text-chef-600"><i class="fas fa-balance-scale"></i> เปรียบเทียบสูตร</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 h-full">
                        <div class="flex flex-col h-full">
                            <div class="flex gap-2 mb-4">
                                <input id="codeA" type="text" placeholder="รหัสสูตรที่ 1" class="flex-1 p-3 rounded-lg border shadow-inner">
                                <button onclick="app.fetchForCompare('codeA', 'resA')" class="bg-blue-500 text-white px-4 rounded-lg"><i class="fas fa-search"></i></button>
                            </div>
                            <div id="resA" class="flex-1 bg-white/50 rounded-xl p-4 border border-dashed border-gray-300 flex items-center justify-center text-gray-400">
                                รอข้อมูล...
                            </div>
                        </div>
                        <div class="flex flex-col h-full">
                            <div class="flex gap-2 mb-4">
                                <input id="codeB" type="text" placeholder="รหัสสูตรที่ 2" class="flex-1 p-3 rounded-lg border shadow-inner">
                                <button onclick="app.fetchForCompare('codeB', 'resB')" class="bg-red-500 text-white px-4 rounded-lg"><i class="fas fa-search"></i></button>
                            </div>
                            <div id="resB" class="flex-1 bg-white/50 rounded-xl p-4 border border-dashed border-gray-300 flex items-center justify-center text-gray-400">
                                รอข้อมูล...
                            </div>
                        </div>
                    </div>
                </div>
            `,
            recipeCard: (data, isOwner) => `
                <div class="glass-panel p-6 rounded-xl hover:shadow-2xl transition duration-300 relative group">
                    <div class="flex justify-between items-start">
                        <div>
                            <span class="bg-chef-100 text-chef-600 text-xs font-bold px-2 py-1 rounded mb-2 inline-block">CODE: ${data.id}</span>
                            <h3 class="text-2xl font-bold text-gray-800">${data.name}</h3>
                            <p class="text-gray-500 text-sm mt-1 line-clamp-2">${data.steps}</p>
                        </div>
                        ${isOwner ? `<button onclick="app.deleteRecipe('${data.id}')" class="text-red-300 hover:text-red-500"><i class="fas fa-trash"></i></button>` : ''}
                    </div>
                    
                    <div class="mt-4 border-t border-gray-200 pt-4">
                        <h4 class="font-bold text-sm text-gray-600 mb-2">วัตถุดิบ:</h4>
                        <div class="grid grid-cols-2 gap-2 text-sm">
                            ${data.ingredients.map(ing => `
                                <div class="flex justify-between bg-white/60 px-2 py-1 rounded">
                                    <span>${ing.name}</span>
                                    <span class="font-bold text-chef-600">${ing.qty} ${ing.unit}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `
        };

        // --- Application Logic ---
        window.app = {
            init: () => {
                onAuthStateChanged(auth, (user) => {
                    state.user = user;
                    app.updateNav();
                    if(user) app.renderDashboard();
                    else app.renderHome();
                });
            },

            updateNav: () => {
                const btnContainer = document.getElementById('auth-buttons');
                if (state.user) {
                    btnContainer.innerHTML = `
                        <span class="text-sm text-chef-900 mr-2">${state.user.email.split('@')[0]}</span>
                        <button onclick="app.logout()" class="bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded-full text-sm font-bold transition">ออกจากระบบ</button>
                    `;
                } else {
                    btnContainer.innerHTML = `
                        <button onclick="app.renderLogin()" class="text-chef-600 hover:underline mr-4">เข้าสู่ระบบ</button>
                        <button onclick="app.renderRegister()" class="bg-chef-500 hover:bg-chef-600 text-white px-5 py-2 rounded-full shadow-lg transition">สมัครสมาชิก</button>
                    `;
                }
            },

            // Navigation Actions
            renderHome: () => {
                document.getElementById('app-container').innerHTML = ui.homeGuest();
            },
            renderLogin: () => document.getElementById('app-container').innerHTML = ui.login(),
            renderRegister: () => document.getElementById('app-container').innerHTML = ui.register(),
            renderDashboard: async () => {
                if(!state.user) return app.renderLogin();
                // Load user recipes
                const q = query(collection(db, "recipes"), where("ownerId", "==", state.user.uid));
                const querySnapshot = await getDocs(q);
                const recipes = [];
                querySnapshot.forEach((doc) => recipes.push({ id: doc.id, ...doc.data() }));
                
                document.getElementById('app-container').innerHTML = ui.dashboard(recipes);
                app.addIngredientRow(); // Add first row
            },
            renderCompare: () => {
                document.getElementById('app-container').innerHTML = ui.compare();
            },

            // Auth Actions
            handleAuth: async (e, type) => {
                e.preventDefault();
                const email = e.target.email.value;
                const password = e.target.password.value;
                try {
                    if(type === 'login') await signInWithEmailAndPassword(auth, email, password);
                    else await createUserWithEmailAndPassword(auth, email, password);
                } catch (error) {
                    alert("Error: " + error.message);
                }
            },
            logout: () => signOut(auth),

            // Recipe Actions
            addIngredientRow: () => {
                const div = document.createElement('div');
                div.className = 'flex gap-2 mb-2 animate-fade-in';
                div.innerHTML = `
                    <input type="text" placeholder="วัตถุดิบ" list="globalIngredients" class="ing-name flex-1 p-2 border rounded text-sm">
                    <input type="number" placeholder="0" class="ing-qty w-16 p-2 border rounded text-sm text-center">
                    <select class="ing-unit w-20 p-2 border rounded text-sm bg-white">
                        <option>กรัม</option><option>ช้อนโต๊ะ</option><option>ช้อนชา</option><option>ถ้วย</option><option>มล.</option><option>ฟอง</option>
                    </select>
                    <button onclick="this.parentElement.remove()" class="text-red-400 hover:text-red-600 px-1"><i class="fas fa-times"></i></button>
                `;
                document.getElementById('ingredient-inputs').appendChild(div);
            },

            saveRecipe: async () => {
                const name = document.getElementById('newRecipeName').value;
                const steps = document.getElementById('newRecipeDesc').value;
                const ings = [];
                document.querySelectorAll('#ingredient-inputs > div').forEach(row => {
                    const n = row.querySelector('.ing-name').value;
                    const q = row.querySelector('.ing-qty').value;
                    const u = row.querySelector('.ing-unit').value;
                    if(n) ings.push({name: n, qty: q, unit: u});
                });

                if(!name || ings.length === 0) return alert("กรุณากรอกชื่อและวัตถุดิบอย่างน้อย 1 อย่าง");

                const code = Math.random().toString(36).substring(2, 8).toUpperCase();
                
                try {
                    await setDoc(doc(db, "recipes", code), {
                        name, steps, ingredients: ings,
                        ownerId: state.user.uid,
                        createdAt: new Date()
                    });
                    alert(`บันทึกสำเร็จ! รหัสสูตรคือ: ${code}`);
                    app.renderDashboard();
                } catch (e) {
                    console.error(e);
                    alert("บันทึกไม่สำเร็จ");
                }
            },

            deleteRecipe: async (id) => {
                if(confirm("ต้องการลบสูตรนี้ใช่ไหม?")) {
                    await deleteDoc(doc(db, "recipes", id));
                    app.renderDashboard();
                }
            },

            // Search & Compare Logic
            searchRecipeGuest: async () => {
                const code = document.getElementById('guestSearchCode').value.trim().toUpperCase();
                if(!code) return;
                
                const resDiv = document.getElementById('guest-result');
                resDiv.innerHTML = '<div class="text-center text-white"><i class="fas fa-spinner fa-spin"></i> กำลังค้นหา...</div>';

                try {
                    const docSnap = await getDoc(doc(db, "recipes", code));
                    if(docSnap.exists()) {
                        resDiv.innerHTML = ui.recipeCard({id: code, ...docSnap.data()}, false);
                    } else {
                        resDiv.innerHTML = '<div class="bg-red-500/80 text-white p-4 rounded text-center">ไม่พบสูตรจากรหัสนี้</div>';
                    }
                } catch(e) { console.error(e); }
            },

            fetchForCompare: async (inputId, resId) => {
                const code = document.getElementById(inputId).value.trim().toUpperCase();
                const resDiv = document.getElementById(resId);
                if(!code) return;

                try {
                    const docSnap = await getDoc(doc(db, "recipes", code));
                    if(docSnap.exists()) {
                        const data = docSnap.data();
                        resDiv.innerHTML = `
                            <div class="w-full text-left">
                                <h3 class="font-bold text-xl text-chef-600 mb-2">${data.name}</h3>
                                <div class="space-y-2">
                                    ${data.ingredients.map(ing => `
                                        <div class="flex justify-between border-b border-gray-200 pb-1">
                                            <span>${ing.name}</span>
                                            <span class="font-bold">${ing.qty} ${ing.unit}</span>
                                        </div>
                                    `).join('')}
                                </div>
                                <p class="mt-4 text-sm text-gray-500 bg-gray-50 p-2 rounded">${data.steps}</p>
                            </div>
                        `;
                        resDiv.classList.remove('justify-center', 'text-gray-400', 'border-dashed');
                        resDiv.classList.add('bg-white');
                    } else {
                        resDiv.innerHTML = "ไม่พบข้อมูล";
                    }
                } catch(e) { console.error(e); }
            }
        };

        // Start App
        app.init();
    </script>
</body>
</html>
