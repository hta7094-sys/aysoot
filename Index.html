<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Aysoot Pro - Dashboard System</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> <style>
        /* --- Core System Styles --- */
        body {
            font-family: 'Prompt', sans-serif;
            background-color: #f8fafc; /* Slate-50 */
            color: #1e293b;
            overscroll-behavior-y: none; /* ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö */
            -webkit-tap-highlight-color: transparent;
        }

        /* Scrollbar ‡∏ã‡πà‡∏≠‡∏ô‡πÉ‡∏´‡πâ‡∏™‡∏ß‡∏¢ */
        ::-webkit-scrollbar { width: 0px; background: transparent; }

        /* Animation */
        .fade-enter { animation: fadeEnter 0.3s ease-in-out; }
        @keyframes fadeEnter { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Input Styles */
        .input-box {
            width: 100%; padding: 12px 16px;
            background: #ffffff; border: 1px solid #e2e8f0;
            border-radius: 12px; font-size: 14px;
            transition: all 0.2s; outline: none;
        }
        .input-box:focus { border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }

        /* Navigation Styles */
        .nav-bar {
            position: fixed; bottom: 0; left: 0; width: 100%;
            height: 75px; background: white;
            border-top: 1px solid #f1f5f9;
            display: grid; grid-template-columns: 1fr 1fr 1fr 1fr;
            padding-bottom: env(safe-area-inset-bottom);
            z-index: 50; box-shadow: 0 -4px 20px rgba(0,0,0,0.03);
        }
        .nav-item {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: #94a3b8; transition: 0.2s; cursor: pointer;
        }
        .nav-item.active { color: #3b82f6; }
        .nav-item.active i { transform: translateY(-2px); }
        
        /* Page Control */
        .page-section { display: none; padding-bottom: 100px; padding-top: 70px; px-4; }
        .page-section.active { display: block; }

        /* Custom Header */
        .header-fixed {
            position: fixed; top: 0; left: 0; width: 100%; height: 60px;
            background: rgba(255,255,255,0.95); backdrop-filter: blur(8px);
            z-index: 40; border-bottom: 1px solid #f1f5f9;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px;
        }

        /* Toast Notification */
        #toast-container {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            z-index: 100; pointer-events: none; width: 90%;
        }
        .toast {
            background: #1e293b; color: white; padding: 12px 20px;
            border-radius: 50px; text-align: center; margin-bottom: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); font-size: 14px;
            animation: slideDown 0.3s ease;
        }
        @keyframes slideDown { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
</head>
<body>

    <header class="header-fixed">
        <div class="flex items-center gap-2">
            <div class="w-8 h-8 rounded-lg bg-blue-600 flex items-center justify-center text-white">
                <i class="fa-solid fa-chart-pie"></i>
            </div>
            <span class="font-bold text-lg text-slate-800">Aysoot Pro</span>
        </div>
        <div id="header-user" class="text-xs text-slate-500 font-medium bg-slate-100 px-3 py-1 rounded-full">...</div>
    </header>

    <main class="container mx-auto max-w-lg px-4">
        
        <div id="page-dashboard" class="page-section active fade-enter">
            <h2 class="text-xl font-bold mb-4">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à</h2>
            
            <div class="grid grid-cols-2 gap-3 mb-6">
                <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl p-4 text-white shadow-lg shadow-blue-200">
                    <div class="text-blue-100 text-xs mb-1">‡∏™‡∏π‡∏ï‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                    <div class="text-3xl font-bold" id="dash-total-recipe">0</div>
                    <div class="text-blue-200 text-[10px] mt-2">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
                </div>
                <div class="bg-white border border-slate-100 rounded-2xl p-4 shadow-sm">
                    <div class="text-slate-400 text-xs mb-1">‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏™‡∏∞‡∏™‡∏°</div>
                    <div class="text-xl font-bold text-slate-800" id="dash-total-cost">0</div>
                    <div class="text-green-500 text-[10px] mt-2 font-bold">+ ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</div>
                </div>
            </div>

            <div class="bg-white rounded-2xl p-5 border border-slate-100 shadow-sm mb-6 relative overflow-hidden">
                <div class="absolute top-0 left-0 w-1 h-full bg-yellow-400"></div>
                <div class="flex justify-between items-start mb-2">
                    <h3 class="font-bold text-slate-700">üèÜ ‡∏™‡∏π‡∏ï‡∏£‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏≥‡πÑ‡∏£‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î</h3>
                    <span class="bg-yellow-100 text-yellow-700 text-[10px] px-2 py-1 rounded-full">Recommended</span>
                </div>
                <div id="dash-best-recipe" class="text-sm text-slate-500">
                    ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏π‡∏ï‡∏£‡πÄ‡∏î‡πá‡∏î
                </div>
            </div>

            <div class="bg-white rounded-2xl p-4 shadow-sm border border-slate-100">
                <h3 class="font-bold text-slate-700 mb-4 text-sm">‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô (5 ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)</h3>
                <canvas id="costChart" height="200"></canvas>
            </div>
        </div>

        <div id="page-list" class="page-section fade-enter">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏π‡∏ï‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£</h2>
                <button onclick="App.renderList()" class="w-8 h-8 rounded-full bg-slate-100 text-slate-500 flex items-center justify-center"><i class="fa-solid fa-rotate"></i></button>
            </div>
            
            <div class="relative mb-6">
                <i class="fa-solid fa-search absolute left-4 top-3.5 text-slate-400"></i>
                <input type="text" id="search-input" onkeyup="App.filterList()" class="input-box pl-10 rounded-full bg-slate-50 border-none shadow-inner" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏°‡∏ô‡∏π...">
            </div>

            <div id="recipe-list-container" class="space-y-3 pb-20">
                </div>
        </div>

        <div id="page-form" class="page-section fade-enter">
            <div class="flex justify-between items-center mb-6">
                <h2 id="form-title" class="text-xl font-bold">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏π‡∏ï‡∏£‡πÉ‡∏´‡∏°‡πà</h2>
                <button onclick="App.resetForm()" class="text-xs text-slate-400 underline">‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤</button>
            </div>

            <div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-100 mb-6">
                <input type="hidden" id="edit-id">
                
                <label class="block text-xs font-bold text-slate-400 mb-2">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏°‡∏ô‡∏π‡∏≠‡∏≤‡∏´‡∏≤‡∏£</label>
                <input type="text" id="inp-name" class="input-box text-lg font-bold text-slate-800 mb-4" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Ç‡πâ‡∏≤‡∏ß‡∏°‡∏±‡∏ô‡πÑ‡∏Å‡πà" autocomplete="off">
                
                <div class="flex items-center gap-3 bg-slate-50 p-3 rounded-xl border border-slate-100">
                    <input type="checkbox" id="inp-best" class="w-5 h-5 text-blue-600 rounded">
                    <label for="inp-best" class="text-sm font-medium text-slate-600">‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏°‡∏ô‡∏π‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ (Highlight)</label>
                </div>
            </div>

            <div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-100 mb-20">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-slate-700">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö</h3>
                    <span id="display-total" class="text-green-600 font-bold text-lg">0 ‡∏ø</span>
                </div>
                
                <div class="grid grid-cols-12 gap-2 text-[10px] text-slate-400 font-bold mb-2">
                    <div class="col-span-6">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
                    <div class="col-span-3 text-center">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</div>
                    <div class="col-span-3 text-right">‡∏£‡∏≤‡∏Ñ‡∏≤</div>
                </div>

                <div id="ing-container" class="space-y-2 mb-4"></div>

                <button onclick="App.addIngRow()" class="w-full py-3 border border-dashed border-slate-300 rounded-xl text-slate-400 text-sm hover:border-blue-400 hover:text-blue-500 transition">
                    + ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö
                </button>

                <div class="mt-8">
                    <button onclick="App.saveRecipe()" class="w-full bg-blue-600 text-white py-4 rounded-xl font-bold text-lg shadow-lg shadow-blue-200 active:scale-95 transition">
                        <i class="fa-solid fa-save mr-2"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                    </button>
                </div>
            </div>
        </div>

        <div id="page-profile" class="page-section fade-enter">
            <h2 class="text-xl font-bold mb-6 text-center">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</h2>
            
            <div class="bg-white rounded-3xl p-8 shadow-sm border border-slate-100 text-center relative overflow-hidden">
                <div class="w-24 h-24 rounded-full bg-slate-200 mx-auto mb-4 overflow-hidden border-4 border-white shadow-lg">
                    <img id="profile-img" src="" class="w-full h-full object-cover">
                </div>
                
                <div id="profile-view">
                    <h3 id="profile-name" class="text-2xl font-bold text-slate-800">User</h3>
                    <p id="profile-email" class="text-slate-400 text-sm mb-6">email@example.com</p>
                    <button onclick="App.toggleProfileEdit()" class="px-6 py-2 bg-slate-100 text-slate-600 rounded-full text-sm font-bold">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                </div>

                <div id="profile-edit" class="hidden space-y-3">
                    <input type="text" id="edit-profile-name" class="input-box text-center" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏Å">
                    <button onclick="App.updateProfile()" class="w-full bg-green-500 text-white py-2 rounded-xl font-bold shadow-md">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                    <button onclick="App.toggleProfileEdit()" class="text-xs text-slate-400 underline">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                </div>
            </div>

            <button onclick="App.logout()" class="w-full mt-6 bg-red-50 text-red-500 py-4 rounded-2xl font-bold hover:bg-red-100 transition">
                ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
            </button>
        </div>

    </main>

    <nav class="nav-bar">
        <div class="nav-item active" onclick="App.nav('dashboard')" id="nav-dashboard">
            <i class="fa-solid fa-chart-pie text-xl mb-1"></i>
            <span class="text-[10px] font-bold">‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</span>
        </div>
        <div class="nav-item" onclick="App.nav('list')" id="nav-list">
            <i class="fa-solid fa-book-open text-xl mb-1"></i>
            <span class="text-[10px] font-bold">‡∏™‡∏π‡∏ï‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£</span>
        </div>
        <div class="nav-item" onclick="App.nav('form')" id="nav-form">
            <div class="w-12 h-12 bg-blue-600 rounded-full flex items-center justify-center text-white shadow-lg shadow-blue-200 -mt-6 border-4 border-white">
                <i class="fa-solid fa-plus text-xl"></i>
            </div>
            <span class="text-[10px] font-bold mt-1">‡∏™‡∏£‡πâ‡∏≤‡∏á/‡πÅ‡∏Å‡πâ</span>
        </div>
        <div class="nav-item" onclick="App.nav('profile')" id="nav-profile">
            <i class="fa-solid fa-user text-xl mb-1"></i>
            <span class="text-[10px] font-bold">‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</span>
        </div>
    </nav>

    <div id="toast-container"></div>

    <div id="auth-modal" class="fixed inset-0 bg-slate-900/50 z-[100] hidden items-center justify-center backdrop-blur-sm p-4">
        <div class="bg-white w-full max-w-sm rounded-3xl p-8 shadow-2xl">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-blue-600 rounded-2xl mx-auto flex items-center justify-center text-white text-2xl mb-4"><i class="fa-solid fa-utensils"></i></div>
                <h2 class="text-2xl font-bold">‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö</h2>
                <p class="text-slate-400 text-sm">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£</p>
            </div>
            <form id="auth-form" onsubmit="App.handleAuth(event)" class="space-y-4">
                <input type="email" id="auth-email" class="input-box bg-slate-50" placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏•" required>
                <input type="password" id="auth-pass" class="input-box bg-slate-50" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" required>
                <button type="submit" class="w-full bg-slate-800 text-white py-3 rounded-xl font-bold text-lg shadow-lg">‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</button>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, query, where, getDocs, deleteDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDVS3zsJSeqOs5Wwpkj-DNbN1vhfc2_3LE",
            authDomain: "aysoot.firebaseapp.com",
            projectId: "aysoot",
            storageBucket: "aysoot.firebasestorage.app",
            messagingSenderId: "56310141842",
            appId: "1:56310141842:web:a08f702a98a39a0eb7274b"
        };

        const appFire = initializeApp(firebaseConfig);
        const auth = getAuth(appFire);
        const db = getFirestore(appFire);

        let user = null;
        let recipesCache = [];
        let chartInstance = null;

        window.App = {
            init: () => {
                onAuthStateChanged(auth, u => {
                    user = u;
                    if(u) {
                        document.getElementById('auth-modal').classList.remove('flex');
                        document.getElementById('auth-modal').classList.add('hidden');
                        document.getElementById('header-user').innerText = u.displayName || 'Chef';
                        document.getElementById('profile-name').innerText = u.displayName || 'Chef';
                        document.getElementById('profile-email').innerText = u.email;
                        document.getElementById('profile-img').src = `https://ui-avatars.com/api/?name=${u.displayName}&background=random`;
                        App.nav('dashboard');
                        App.fetchData();
                    } else {
                        document.getElementById('auth-modal').classList.remove('hidden');
                        document.getElementById('auth-modal').classList.add('flex');
                    }
                });
            },

            // Navigation Logic
            nav: (page) => {
                document.querySelectorAll('.page-section').forEach(el => el.classList.remove('active'));
                document.getElementById(`page-${page}`).classList.add('active');
                
                document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                document.getElementById(`nav-${page}`).classList.add('active');

                if(page === 'dashboard') App.renderDashboard();
                if(page === 'list') App.renderList();
            },

            // --- DATA & DASHBOARD ---
            fetchData: async () => {
                if(!user) return;
                try {
                    const q = query(collection(db, "recipes"), where("ownerId", "==", user.uid));
                    const snap = await getDocs(q);
                    recipesCache = [];
                    snap.forEach(d => recipesCache.push({ id: d.id, ...d.data() }));
                    recipesCache.sort((a,b) => (b.createdAt?.seconds||0) - (a.createdAt?.seconds||0));
                    App.renderDashboard();
                } catch(e) { console.error(e); }
            },

            renderDashboard: () => {
                const totalRecipes = recipesCache.length;
                let totalCost = 0;
                let bestRecipe = null;
                const labels = [];
                const dataCost = [];

                recipesCache.forEach(r => {
                    const cost = parseFloat(r.totalCost) || 0;
                    totalCost += cost;
                    if(r.isBest) bestRecipe = r;
                    
                    // Prepare Chart Data (Top 5)
                    if(labels.length < 5) {
                        labels.push(r.name.substring(0, 10));
                        dataCost.push(cost);
                    }
                });

                document.getElementById('dash-total-recipe').innerText = totalRecipes;
                document.getElementById('dash-total-cost').innerText = totalCost.toLocaleString() + ' ‡∏ø';
                
                const bestEl = document.getElementById('dash-best-recipe');
                if(bestRecipe) {
                    bestEl.innerHTML = `
                        <div class="font-bold text-lg text-slate-800">${bestRecipe.name}</div>
                        <div class="text-green-600 font-bold">‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô: ${parseFloat(bestRecipe.totalCost).toLocaleString()} ‡∏ø</div>
                    `;
                } else {
                    bestEl.innerHTML = `<span class="text-slate-400">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏°‡∏ô‡∏π‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</span>`;
                }

                // Render Chart
                const ctx = document.getElementById('costChart').getContext('2d');
                if(chartInstance) chartInstance.destroy();
                chartInstance = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: dataCost,
                            backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'],
                            borderWidth: 0
                        }]
                    },
                    options: { maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { boxWidth: 10, font: {size: 10} } } } }
                });
            },

            // --- LIST PAGE ---
            renderList: () => {
                const container = document.getElementById('recipe-list-container');
                container.innerHTML = '';
                
                if(recipesCache.length === 0) {
                    container.innerHTML = `<div class="text-center text-slate-400 mt-10">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>`;
                    return;
                }

                recipesCache.forEach(r => {
                    const cost = parseFloat(r.totalCost).toLocaleString();
                    const div = document.createElement('div');
                    div.className = "bg-white p-4 rounded-xl shadow-sm border border-slate-100 flex justify-between items-center relative overflow-hidden group";
                    div.innerHTML = `
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-lg ${r.isBest ? 'bg-yellow-100 text-yellow-600' : 'bg-slate-100 text-slate-500'} flex items-center justify-center font-bold">
                                ${r.name.charAt(0)}
                            </div>
                            <div>
                                <div class="font-bold text-slate-800">${r.name}</div>
                                <div class="text-xs text-slate-400">${r.ingredients.length} ‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="font-bold text-green-600">${cost} ‡∏ø</div>
                            <div class="flex gap-2 mt-1 justify-end">
                                <button class="text-slate-400 hover:text-blue-500 text-xs px-2 py-1 bg-slate-50 rounded" onclick="App.editRecipe('${r.id}')"><i class="fa-solid fa-pen"></i> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                                <button class="text-slate-400 hover:text-red-500 text-xs px-2 py-1 bg-slate-50 rounded" onclick="App.deleteRecipe('${r.id}')"><i class="fa-solid fa-trash"></i></button>
                            </div>
                        </div>
                        ${r.isBest ? '<div class="absolute top-0 left-0 w-1 h-full bg-yellow-400"></div>' : ''}
                    `;
                    container.appendChild(div);
                });
            },
            
            filterList: () => {
                const term = document.getElementById('search-input').value.toLowerCase();
                const items = document.querySelectorAll('#recipe-list-container > div');
                items.forEach(item => {
                    const txt = item.innerText.toLowerCase();
                    item.style.display = txt.includes(term) ? 'flex' : 'none';
                });
            },

            // --- FORM & EDIT LOGIC ---
            resetForm: () => {
                document.getElementById('form-title').innerText = "‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏π‡∏ï‡∏£‡πÉ‡∏´‡∏°‡πà";
                document.getElementById('edit-id').value = "";
                document.getElementById('inp-name').value = "";
                document.getElementById('inp-best').checked = false;
                document.getElementById('ing-container').innerHTML = "";
                document.getElementById('display-total').innerText = "0 ‡∏ø";
                App.addIngRow(); // Add 1 row default
            },

            addIngRow: (data = null) => {
                const container = document.getElementById('ing-container');
                const row = document.createElement('div');
                row.className = "grid grid-cols-12 gap-2 ing-row mb-2";
                row.innerHTML = `
                    <div class="col-span-6"><input type="text" class="input-box ing-name p-2" placeholder="‡∏ä‡∏∑‡πà‡∏≠" value="${data?.name||''}"></div>
                    <div class="col-span-3"><input type="text" class="input-box ing-qty p-2 text-center" placeholder="1" value="${data?.qty||''}"></div>
                    <div class="col-span-3 relative">
                        <input type="number" class="input-box ing-price p-2 text-right font-bold" placeholder="0" oninput="App.calcTotal()" value="${data?.price||''}">
                        <button onclick="this.parentElement.parentElement.remove(); App.calcTotal()" class="absolute -right-2 -top-2 bg-red-100 text-red-500 rounded-full w-5 h-5 flex items-center justify-center text-[10px]"><i class="fa-solid fa-xmark"></i></button>
                    </div>
                `;
                container.appendChild(row);
                App.calcTotal();
            },

            calcTotal: () => {
                let total = 0;
                document.querySelectorAll('.ing-price').forEach(e => total += parseFloat(e.value) || 0);
                document.getElementById('display-total').innerText = total.toLocaleString() + " ‡∏ø";
                return total;
            },

            saveRecipe: async () => {
                const id = document.getElementById('edit-id').value;
                const name = document.getElementById('inp-name').value;
                const isBest = document.getElementById('inp-best').checked;
                const ingredients = [];
                
                document.querySelectorAll('.ing-row').forEach(row => {
                    const n = row.querySelector('.ing-name').value;
                    const q = row.querySelector('.ing-qty').value;
                    const p = row.querySelector('.ing-price').value;
                    if(n) ingredients.push({name:n, qty:q, price:p});
                });

                if(!name || ingredients.length === 0) return App.toast("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö");

                App.toast("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...");
                const totalCost = App.calcTotal();
                const data = {
                    name, ingredients, isBest, totalCost,
                    ownerId: user.uid, ownerName: user.displayName,
                    updatedAt: serverTimestamp()
                };

                try {
                    if(id) {
                        // Update
                        await updateDoc(doc(db, "recipes", id), data);
                        App.toast("‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
                    } else {
                        // Create New
                        const newId = Math.random().toString(36).substring(2, 8).toUpperCase();
                        data.createdAt = serverTimestamp();
                        await setDoc(doc(db, "recipes", newId), data);
                        App.toast("‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏π‡∏ï‡∏£‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡πâ‡∏ß");
                    }
                    App.resetForm();
                    App.fetchData(); // Refresh Data
                    App.nav('list');
                } catch(e) { App.toast("Error: " + e.message); }
            },

            editRecipe: (id) => {
                const r = recipesCache.find(x => x.id === id);
                if(!r) return;
                
                App.resetForm();
                document.getElementById('form-title').innerText = "‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏π‡∏ï‡∏£: " + r.name;
                document.getElementById('edit-id').value = r.id;
                document.getElementById('inp-name').value = r.name;
                document.getElementById('inp-best').checked = r.isBest;
                
                document.getElementById('ing-container').innerHTML = "";
                r.ingredients.forEach(ing => App.addIngRow(ing));
                
                App.nav('form');
            },

            deleteRecipe: async (id) => {
                if(!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏™‡∏π‡∏ï‡∏£‡∏ô‡∏µ‡πâ?')) return;
                await deleteDoc(doc(db, "recipes", id));
                App.fetchData();
                App.renderList();
                App.toast("‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß");
            },

            // --- PROFILE LOGIC ---
            toggleProfileEdit: () => {
                const view = document.getElementById('profile-view');
                const edit = document.getElementById('profile-edit');
                if(view.classList.contains('hidden')) {
                    view.classList.remove('hidden');
                    edit.classList.add('hidden');
                } else {
                    view.classList.add('hidden');
                    edit.classList.remove('hidden');
                    document.getElementById('edit-profile-name').value = user.displayName;
                }
            },

            updateProfile: async () => {
                const newName = document.getElementById('edit-profile-name').value;
                if(!newName) return;
                try {
                    await updateProfile(user, { displayName: newName });
                    document.getElementById('profile-name').innerText = newName;
                    document.getElementById('header-user').innerText = newName;
                    App.toggleProfileEdit();
                    App.toast("‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
                } catch(e) { App.toast(e.message); }
            },

            handleAuth: async (e) => {
                e.preventDefault();
                const email = document.getElementById('auth-email').value;
                const pass = document.getElementById('auth-pass').value;
                try {
                    await signInWithEmailAndPassword(auth, email, pass);
                } catch(err) { alert("Login Failed: " + err.message); }
            },

            logout: () => signOut(auth),

            toast: (msg) => {
                const div = document.createElement('div');
                div.className = 'toast'; div.innerText = msg;
                document.getElementById('toast-container').appendChild(div);
                setTimeout(() => div.remove(), 3000);
            }
        };

        App.init();
    </script>
</body>
</html>
