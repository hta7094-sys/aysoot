<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Aysoot Elite</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        /* --- Theme --- */
        :root {
            --primary: #f59e0b;
            --primary-dark: #d97706;
            --bg: #fffbeb;
        }

        body {
            font-family: 'Prompt', sans-serif;
            background-color: var(--bg);
            color: #451a03;
            overscroll-behavior-y: none;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            padding-bottom: 90px;
            user-select: none;
        }
        
        input, textarea, select { user-select: text; }

        /* UI Elements */
        .card-stat {
            background: white; border-radius: 24px;
            padding: 20px; position: relative; overflow: hidden;
            box-shadow: 0 4px 20px rgba(245, 158, 11, 0.08);
            border: 1px solid rgba(255,255,255,0.8);
        }

        .input-std {
            width: 100%; padding: 12px 16px;
            background: #fff; border: 1px solid #fed7aa;
            border-radius: 14px; font-size: 14px; outline: none;
            -webkit-appearance: none; transition: 0.3s;
        }
        .input-std:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(245,158,11,0.1); }

        .code-box {
            background: #fff7ed; border: 2px dashed #fcd34d;
            border-radius: 16px; padding: 16px;
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px;
        }

        /* Navigation */
        .nav-bar {
            position: fixed; bottom: 0; left: 0; width: 100%;
            height: 80px; background: white;
            border-top: 1px solid #fed7aa;
            display: grid; grid-template-columns: repeat(4, 1fr);
            padding-bottom: env(safe-area-inset-bottom);
            z-index: 50; border-radius: 24px 24px 0 0;
            box-shadow: 0 -10px 30px rgba(0,0,0,0.03);
        }
        .nav-item {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: #d6d3d1; transition: 0.2s; cursor: pointer;
        }
        .nav-item.active { color: var(--primary); transform: translateY(-2px); }

        /* List Item */
        .recipe-item {
            background: white; padding: 16px; border-radius: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.02);
            border: 1px solid #fff; margin-bottom: 12px;
            display: flex; align-items: center; gap: 12px;
            transition: 0.1s;
        }
        .recipe-item:active { transform: scale(0.98); }

        .page { display: none; padding: 20px; animation: fadeIn 0.3s; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <header class="fixed top-0 left-0 w-full h-[60px] bg-white/90 backdrop-blur z-40 flex items-center justify-between px-5 border-b border-orange-100">
        <div class="flex items-center gap-2 text-amber-600">
            <i class="fa-solid fa-fire-burner text-xl"></i>
            <span class="font-bold text-lg text-slate-800">Aysoot Elite</span>
        </div>
        <div class="flex items-center gap-2">
            <span id="header-name" class="text-xs font-bold text-slate-500">...</span>
            <div class="w-8 h-8 rounded-full bg-slate-200 overflow-hidden border border-amber-200">
                <img id="header-img" src="" class="w-full h-full object-cover">
            </div>
        </div>
    </header>
    <div class="h-[60px]"></div>

    <main class="container mx-auto max-w-md">

        <div id="pg-dashboard" class="page active">
            <h2 class="text-2xl font-bold text-slate-800">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏° üìä</h2>
            <p class="text-slate-400 text-xs mb-6">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏°‡∏∑‡∏≠‡∏≠‡∏≤‡∏ä‡∏µ‡∏û</p>

            <div class="grid grid-cols-2 gap-3 mb-6">
                <div class="card-stat">
                    <div class="absolute -right-2 -top-2 w-16 h-16 bg-blue-50 rounded-full opacity-50"></div>
                    <i class="fa-solid fa-book-open text-blue-400 text-xl mb-2"></i>
                    <p class="text-slate-400 text-[10px] font-bold uppercase">‡∏™‡∏π‡∏ï‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
                    <p id="stat-total" class="text-3xl font-bold text-slate-800">0</p>
                </div>
                <div class="card-stat">
                    <div class="absolute -right-2 -top-2 w-16 h-16 bg-amber-50 rounded-full opacity-50"></div>
                    <i class="fa-solid fa-star text-amber-400 text-xl mb-2"></i>
                    <p class="text-slate-400 text-[10px] font-bold uppercase">‡∏™‡∏π‡∏ï‡∏£‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</p>
                    <p id="stat-best" class="text-3xl font-bold text-slate-800">0</p>
                </div>
            </div>

            <div class="flex justify-between items-center mb-3 px-1">
                <h3 class="font-bold text-slate-700">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h3>
                <span class="text-[10px] text-slate-400">‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏î‡∏≤‡∏ß ‚≠ê ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</span>
            </div>
            <div id="list-container" class="pb-20"></div>
        </div>

        <div id="pg-search" class="page">
            <div class="mt-8 bg-white rounded-[32px] p-8 text-center shadow-lg border border-orange-50">
                <div class="w-16 h-16 bg-amber-50 rounded-full flex items-center justify-center mx-auto mb-4 text-amber-500 text-2xl">
                    <i class="fa-solid fa-search"></i>
                </div>
                <h2 class="text-xl font-bold text-slate-800">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏π‡∏ï‡∏£</h2>
                <p class="text-slate-400 text-xs mb-6">‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™ Code 6 ‡∏´‡∏•‡∏±‡∏Å‡∏Ç‡∏≠‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô</p>
                
                <input type="text" id="search-inp" maxlength="6" class="w-full text-center text-3xl font-bold tracking-[8px] uppercase border-b-2 border-orange-200 py-3 mb-6 focus:border-amber-500 outline-none bg-transparent placeholder-slate-200" placeholder="CODE">
                
                <button onclick="App.searchRecipe()" class="w-full bg-slate-800 text-white py-4 rounded-xl font-bold shadow-lg active:scale-95 transition">
                    ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
                </button>
            </div>
        </div>

        <div id="pg-form" class="page">
            <div class="flex justify-between items-center mb-4">
                <h2 id="form-title" class="text-xl font-bold">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏π‡∏ï‡∏£‡πÉ‡∏´‡∏°‡πà üç≥</h2>
                <button onclick="App.resetForm()" class="text-xs text-slate-400">‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤</button>
            </div>

            <div class="bg-white p-5 rounded-2xl shadow-sm border border-orange-100 mb-4">
                <label class="text-xs font-bold text-slate-400">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏°‡∏ô‡∏π</label>
                <input type="text" id="inp-name" class="input-std font-bold text-lg mt-1" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÑ‡∏Å‡πà‡∏ó‡∏≠‡∏î‡∏´‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà">
                
                <div class="mt-4 flex items-center gap-2 cursor-pointer" onclick="document.getElementById('inp-best').click()">
                    <input type="checkbox" id="inp-best" class="w-5 h-5 accent-amber-500 cursor-pointer">
                    <label class="text-sm font-bold text-slate-600 cursor-pointer">‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏°‡∏ô‡∏π‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</label>
                </div>
            </div>

            <div class="bg-white p-5 rounded-2xl shadow-sm border border-orange-100 mb-20">
                <div class="flex justify-between items-end mb-4">
                    <h3 class="font-bold text-slate-700">‡∏™‡πà‡∏ß‡∏ô‡∏ú‡∏™‡∏°</h3>
                    <div class="text-right">
                        <p class="text-[10px] text-slate-400">‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏£‡∏ß‡∏°</p>
                        <p id="form-total" class="text-xl font-bold text-green-600">0 ‡∏ø</p>
                    </div>
                </div>

                <div id="ing-list" class="space-y-3 mb-5"></div>

                <button onclick="App.addIngRow()" class="w-full py-3 border-2 border-dashed border-slate-300 rounded-xl text-slate-400 font-bold hover:border-amber-400 hover:text-amber-500 transition mb-4">
                    + ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                </button>

                <button onclick="App.saveRecipe()" class="w-full bg-gradient-to-r from-amber-500 to-orange-600 text-white py-4 rounded-xl font-bold shadow-xl active:scale-95 transition">
                    ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏π‡∏ï‡∏£
                </button>
            </div>
        </div>

        <div id="pg-profile" class="page">
            <div class="bg-white rounded-[32px] p-8 text-center shadow-lg border border-orange-50 mt-6 relative overflow-hidden">
                <div class="absolute top-0 left-0 w-full h-24 bg-gradient-to-br from-amber-400 to-orange-500"></div>
                
                <div class="relative w-28 h-28 mx-auto -mt-12 mb-4">
                    <div class="w-full h-full rounded-full border-4 border-white bg-white overflow-hidden shadow-md">
                        <img id="pf-img" src="" class="w-full h-full object-cover">
                    </div>
                    <div onclick="App.editProfile()" class="absolute bottom-1 right-1 w-8 h-8 bg-white rounded-full flex items-center justify-center shadow text-amber-500 cursor-pointer">
                        <i class="fa-solid fa-pen text-xs"></i>
                    </div>
                </div>

                <h2 id="pf-name" class="text-xl font-bold text-slate-800">User Name</h2>
                <p id="pf-email" class="text-slate-400 text-xs mb-6">user@example.com</p>
                <button onclick="App.logout()" class="w-full py-3 bg-red-50 text-red-500 rounded-xl font-bold text-sm">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
            </div>
        </div>

        <div id="pg-view" class="page">
            <button onclick="App.nav('dashboard')" class="mb-4 text-slate-500 font-bold text-sm flex items-center gap-2">
                <i class="fa-solid fa-arrow-left"></i> ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö
            </button>

            <div class="code-box">
                <div>
                    <span class="text-[10px] text-slate-400 block font-bold">RECIPE CODE</span>
                    <span id="view-id" class="text-xl font-mono font-bold text-slate-800 tracking-wider">------</span>
                </div>
                <button onclick="App.copyCode()" class="bg-amber-500 text-white px-4 py-2 rounded-lg font-bold text-sm shadow-md active:scale-95 transition">
                    ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å
                </button>
            </div>

            <div class="bg-white rounded-[24px] overflow-hidden shadow-lg border border-slate-100 mb-20 relative">
                <div class="bg-gradient-to-br from-amber-500 to-orange-600 p-6 text-white">
                    <h1 id="view-name" class="text-2xl font-bold mb-1">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏°‡∏ô‡∏π</h1>
                    <div class="flex items-center gap-2 mb-6">
                        <img id="view-owner-img" src="" class="w-6 h-6 rounded-full border border-white/50 bg-white">
                        <p id="view-owner" class="text-xs opacity-90">By Chef</p>
                    </div>
                    
                    <div class="flex justify-between items-end border-t border-white/20 pt-4">
                        <span class="text-sm opacity-90">‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</span>
                        <span id="view-cost" class="text-4xl font-bold">0 ‡∏ø</span>
                    </div>
                </div>

                <div class="p-6">
                    <ul id="view-items" class="space-y-3"></ul>
                </div>

                <div id="view-actions" class="p-4 bg-slate-50 flex gap-3 hidden">
                    <button onclick="App.editCurrent()" class="flex-1 py-3 bg-white border border-slate-200 rounded-xl font-bold text-slate-700 shadow-sm">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                    <button onclick="App.deleteCurrent()" class="flex-1 py-3 bg-red-50 text-red-500 rounded-xl font-bold shadow-sm">‡∏•‡∏ö</button>
                </div>
            </div>
        </div>

    </main>

    <nav class="nav-bar">
        <div class="nav-item active" onclick="App.nav('dashboard')" id="btn-dashboard">
            <i class="fa-solid fa-chart-pie text-xl mb-1"></i>
            <span class="text-[10px] font-bold">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</span>
        </div>
        <div class="nav-item" onclick="App.nav('search')" id="btn-search">
            <i class="fa-solid fa-search text-xl mb-1"></i>
            <span class="text-[10px] font-bold">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</span>
        </div>
        <div class="nav-item" onclick="App.nav('form')" id="btn-form">
            <div class="w-12 h-12 bg-amber-500 rounded-full flex items-center justify-center text-white shadow-lg shadow-amber-200 -mt-8 border-4 border-white">
                <i class="fa-solid fa-plus text-xl"></i>
            </div>
        </div>
        <div class="nav-item" onclick="App.nav('profile')" id="btn-profile">
            <i class="fa-solid fa-user text-xl mb-1"></i>
            <span class="text-[10px] font-bold">‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</span>
        </div>
    </nav>

    <div id="auth-modal" class="fixed inset-0 bg-slate-900/95 z-[100] hidden items-center justify-center p-6 backdrop-blur-sm">
        <div class="bg-white w-full max-w-sm rounded-[32px] p-8 text-center shadow-2xl relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-amber-400 to-orange-500"></div>

            <div class="w-16 h-16 bg-amber-100 rounded-2xl mx-auto flex items-center justify-center text-amber-600 text-2xl mb-4 shadow-sm">
                <i class="fa-solid fa-fire-burner"></i>
            </div>
            
            <h2 id="auth-title" class="text-2xl font-bold text-slate-800">‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö</h2>
            <p id="auth-desc" class="text-slate-400 text-sm mb-6">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏Ñ‡∏£‡∏±‡∏ß Aysoot ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô</p>
            
            <form onsubmit="App.handleAuth(event)" class="space-y-3">
                <div id="field-name" class="hidden text-left">
                    <label class="text-[10px] font-bold text-slate-400 ml-2">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡∏ü</label>
                    <input type="text" id="log-name" class="input-std bg-slate-50" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•">
                </div>
                <div class="text-left">
                    <label class="text-[10px] font-bold text-slate-400 ml-2">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
                    <input type="email" id="log-email" class="input-std bg-slate-50" placeholder="hello@example.com" required>
                </div>
                <div class="text-left">
                    <label class="text-[10px] font-bold text-slate-400 ml-2">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
                    <input type="password" id="log-pass" class="input-std bg-slate-50" placeholder="********" required>
                </div>
                
                <button type="submit" id="btn-auth" class="w-full bg-slate-800 text-white py-3 rounded-xl font-bold shadow-lg hover:bg-slate-700 transition mt-2">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
            </form>

            <div class="mt-6 pt-4 border-t border-slate-100">
                <p class="text-xs text-slate-400">
                    <span id="txt-switch">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ?</span> 
                    <button onclick="App.toggleAuthMode()" class="font-bold text-amber-600 hover:underline ml-1">
                        <span id="btn-switch">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</span>
                    </button>
                </p>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, query, where, getDocs, deleteDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const appFire = initializeApp({
            apiKey: "AIzaSyDVS3zsJSeqOs5Wwpkj-DNbN1vhfc2_3LE",
            authDomain: "aysoot.firebaseapp.com",
            projectId: "aysoot",
            storageBucket: "aysoot.firebasestorage.app",
            messagingSenderId: "56310141842",
            appId: "1:56310141842:web:a08f702a98a39a0eb7274b"
        });
        const auth = getAuth(appFire);
        const db = getFirestore(appFire);

        let user = null;
        let recipes = [];
        let editId = null;
        let viewId = null;
        let isRegisterMode = false;

        const units = ["‡∏Å‡∏£‡∏±‡∏°", "‡∏Å‡∏Å.", "‡∏°‡∏•.", "‡∏•‡∏¥‡∏ï‡∏£", "‡∏ä‡πâ‡∏≠‡∏ô‡πÇ‡∏ï‡πä‡∏∞", "‡∏ä‡πâ‡∏≠‡∏ô‡∏ä‡∏≤", "‡∏ü‡∏≠‡∏á", "‡∏ä‡∏¥‡πâ‡∏ô", "‡∏ñ‡πâ‡∏ß‡∏¢", "‡∏°‡∏±‡∏î", "‡πÅ‡∏û‡πá‡∏Ñ"];

        window.App = {
            init: () => {
                onAuthStateChanged(auth, u => {
                    user = u;
                    const modal = document.getElementById('auth-modal');
                    if(u) {
                        modal.style.display = 'none';
                        App.updateProfileUI(u);
                        App.loadData();
                        App.nav('dashboard');
                    } else {
                        modal.style.display = 'flex';
                    }
                });
            },

            // --- AUTHENTICATION ---
            toggleAuthMode: () => {
                isRegisterMode = !isRegisterMode;
                const fieldName = document.getElementById('field-name');
                const title = document.getElementById('auth-title');
                const btn = document.getElementById('btn-auth');
                const txtSwitch = document.getElementById('txt-switch');
                const btnSwitch = document.getElementById('btn-switch');

                if(isRegisterMode) {
                    fieldName.classList.remove('hidden');
                    title.innerText = "‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å";
                    btn.innerText = "‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô";
                    txtSwitch.innerText = "‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß?";
                    btnSwitch.innerText = "‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö";
                } else {
                    fieldName.classList.add('hidden');
                    title.innerText = "‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö";
                    btn.innerText = "‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö";
                    txtSwitch.innerText = "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ?";
                    btnSwitch.innerText = "‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å";
                }
            },

            handleAuth: async (e) => {
                e.preventDefault();
                const em = document.getElementById('log-email').value;
                const pw = document.getElementById('log-pass').value;
                const nm = document.getElementById('log-name').value;

                try {
                    Swal.showLoading();
                    if(isRegisterMode) {
                        if(!nm) throw new Error("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠");
                        const res = await createUserWithEmailAndPassword(auth, em, pw);
                        await updateProfile(res.user, { displayName: nm });
                    } else {
                        await signInWithEmailAndPassword(auth, em, pw);
                    }
                    Swal.close();
                } catch(err) { Swal.fire('Error', err.message, 'error'); }
            },

            logout: () => signOut(auth),

            getAvatar: (name) => `https://api.dicebear.com/9.x/adventurer/svg?seed=${name || 'Chef'}`,

            updateProfileUI: (u) => {
                const img = App.getAvatar(u.displayName);
                const name = u.displayName || 'Chef';
                
                document.getElementById('header-name').innerText = name;
                document.getElementById('header-img').src = img;
                
                document.getElementById('pf-name').innerText = name;
                document.getElementById('pf-email').innerText = u.email;
                document.getElementById('pf-img').src = img;
            },

            editProfile: async () => {
                const { value: name } = await Swal.fire({
                    title: '‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠',
                    input: 'text',
                    inputValue: user.displayName,
                    showCancelButton: true
                });
                if(name) {
                    await updateProfile(user, { displayName: name });
                    App.updateProfileUI(user);
                }
            },

            // --- NAVIGATION ---
            nav: (p) => {
                document.querySelectorAll('.page').forEach(e => e.classList.remove('active'));
                document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
                
                document.getElementById(`pg-${p}`).classList.add('active');
                const btn = document.getElementById(`btn-${p}`);
                if(btn) btn.classList.add('active');

                if(p === 'form' && !editId) App.resetForm();
            },

            // --- DATA LOGIC ---
            loadData: async () => {
                if(!user) return;
                const q = query(collection(db, "recipes"), where("ownerId", "==", user.uid));
                const snap = await getDocs(q);
                recipes = [];
                snap.forEach(d => recipes.push({id: d.id, ...d.data()}));
                recipes.sort((a,b) => (b.createdAt?.seconds||0) - (a.createdAt?.seconds||0));
                App.renderDashboard();
            },

            renderDashboard: () => {
                document.getElementById('stat-total').innerText = recipes.length;
                document.getElementById('stat-best').innerText = recipes.filter(r => r.isBest).length;

                const con = document.getElementById('list-container');
                con.innerHTML = "";
                if(recipes.length === 0) con.innerHTML = `<p class="text-center text-slate-300 mt-10">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>`;
                
                recipes.forEach(r => {
                    const div = document.createElement('div');
                    div.className = "recipe-item relative";
                    div.innerHTML = `
                        <div onclick="App.toggleBest('${r.id}', ${r.isBest})" class="w-10 h-10 rounded-xl flex items-center justify-center cursor-pointer transition ${r.isBest ? 'bg-amber-100 text-amber-500' : 'bg-slate-100 text-slate-300'}">
                            <i class="fa-solid fa-star text-lg"></i>
                        </div>
                        <div class="flex-1 cursor-pointer" onclick="App.openView('${r.id}', true)">
                            <h4 class="font-bold text-slate-800 text-sm">${r.name}</h4>
                            <span class="text-[10px] text-slate-400 font-mono">ID: ${r.id}</span>
                        </div>
                        <div class="text-right cursor-pointer" onclick="App.openView('${r.id}', true)">
                            <p class="font-bold text-green-600 text-lg">${parseFloat(r.totalCost).toLocaleString()}</p>
                            <p class="text-[10px] text-slate-400">‡∏ö‡∏≤‡∏ó</p>
                        </div>
                    `;
                    con.appendChild(div);
                });
            },

            toggleBest: async (id, cur) => {
                const r = recipes.find(x => x.id === id);
                if(r) r.isBest = !cur;
                App.renderDashboard();
                await updateDoc(doc(db, "recipes", id), { isBest: !cur });
            },

            // --- FORM (AUTO VERSIONING) ---
            resetForm: () => {
                editId = null;
                document.getElementById('form-title').innerText = "‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏π‡∏ï‡∏£‡πÉ‡∏´‡∏°‡πà üç≥";
                document.getElementById('inp-name').value = "";
                document.getElementById('inp-best').checked = false;
                document.getElementById('ing-list').innerHTML = "";
                document.getElementById('form-total').innerText = "0 ‡∏ø";
                App.addIngRow();
            },

            addIngRow: (data = null) => {
                const div = document.createElement('div');
                div.className = "ing-row flex gap-2 mb-2 animate-pulse-once";
                let ops = units.map(u => `<option value="${u}" ${data?.unit===u?'selected':''}>${u}</option>`).join('');
                div.innerHTML = `
                    <div class="flex-1 space-y-2">
                        <div class="flex gap-2">
                            <input type="text" class="input-std i-name font-bold" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö" value="${data?.name||''}">
                            <button onclick="this.closest('.ing-row').remove(); App.calcTotal()" class="w-10 bg-red-50 text-red-500 rounded-lg border border-red-100"><i class="fa-solid fa-xmark"></i></button>
                        </div>
                        <div class="flex gap-2">
                            <input type="number" class="input-std i-qty w-20 text-center" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô" value="${data?.qty||''}">
                            <select class="input-std i-unit w-20 bg-white p-0 text-center text-xs">${ops}</select>
                            <input type="number" class="input-std i-price flex-1 text-right font-bold text-green-600" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤" oninput="App.calcTotal()" value="${data?.price||''}">
                        </div>
                    </div>
                `;
                document.getElementById('ing-list').appendChild(div);
            },

            calcTotal: () => {
                let sum = 0;
                document.querySelectorAll('.i-price').forEach(e => sum += parseFloat(e.value)||0);
                document.getElementById('form-total').innerText = sum.toLocaleString() + " ‡∏ø";
                return sum;
            },

            saveRecipe: async () => {
                let name = document.getElementById('inp-name').value.trim();
                const isBest = document.getElementById('inp-best').checked;
                const ings = [];
                document.querySelectorAll('.ing-row').forEach(row => {
                    const n = row.querySelector('.i-name').value.trim();
                    const q = row.querySelector('.i-qty').value;
                    const u = row.querySelector('.i-unit').value;
                    const p = row.querySelector('.i-price').value;
                    if(n) ings.push({name:n, qty:q, unit:u, price:p});
                });

                if(!name || ings.length === 0) return Swal.fire('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö', '', 'warning');

                // --- Auto Versioning Logic ---
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏ã‡πâ‡∏≥ (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ñ‡πâ‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏°‡∏ô‡∏π‡πÉ‡∏´‡∏°‡πà)
                // loop ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á)
                let baseName = name;
                let counter = 2;
                let isDuplicate = true;

                while(isDuplicate) {
                    // ‡∏´‡∏≤‡∏ß‡πà‡∏≤‡∏°‡∏µ‡πÄ‡∏°‡∏ô‡∏π‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á Edit ‡∏≠‡∏¢‡∏π‡πà)
                    const exist = recipes.some(r => r.name === name && r.id !== editId);
                    if(exist) {
                        name = `${baseName} (v${counter})`; // ‡πÄ‡∏ï‡∏¥‡∏° (v2), (v3)...
                        counter++;
                    } else {
                        isDuplicate = false; // ‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥‡πÅ‡∏•‡πâ‡∏ß ‡∏´‡∏•‡∏∏‡∏î loop
                    }
                }
                // -----------------------------

                const total = App.calcTotal();
                const payload = {
                    name, ingredients: ings, isBest, totalCost: total,
                    ownerId: user.uid, ownerName: user.displayName,
                    updatedAt: serverTimestamp()
                };

                try {
                    Swal.showLoading();
                    if(editId) {
                        await updateDoc(doc(db, "recipes", editId), payload);
                    } else {
                        const newId = Math.random().toString(36).substring(2, 8).toUpperCase();
                        payload.createdAt = serverTimestamp();
                        await setDoc(doc(db, "recipes", newId), payload);
                    }
                    Swal.fire({icon:'success', title:'‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß', text: `‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏°‡∏ô‡∏π: ${name}`, timer:1500, showConfirmButton:false});
                    App.loadData();
                    App.nav('dashboard');
                } catch(e) { Swal.fire('Error', e.message, 'error'); }
            },

            // --- VIEW ---
            openView: (id, isMyList, data = null) => {
                viewId = id;
                const r = isMyList ? recipes.find(x => x.id === id) : data;
                if(!r) return;

                document.getElementById('view-name').innerText = r.name;
                document.getElementById('view-id').innerText = id;
                document.getElementById('view-cost').innerText = parseFloat(r.totalCost).toLocaleString() + " ‡∏ø";
                document.getElementById('view-owner').innerText = `By ${r.ownerName}`;
                document.getElementById('view-owner-img').src = App.getAvatar(r.ownerName);
                
                const ul = document.getElementById('view-items');
                ul.innerHTML = "";
                r.ingredients.forEach(i => {
                    ul.innerHTML += `
                        <li class="flex justify-between py-2 border-b border-dashed border-slate-200">
                            <div>
                                <div class="text-slate-700 font-medium text-sm">${i.name}</div>
                                <div class="text-[10px] text-slate-400">${i.qty} ${i.unit}</div>
                            </div>
                            <div class="font-bold text-slate-800 text-sm">${parseFloat(i.price).toLocaleString()}</div>
                        </li>
                    `;
                });

                const acts = document.getElementById('view-actions');
                if(user && r.ownerId === user.uid) acts.classList.remove('hidden');
                else acts.classList.add('hidden');

                App.nav('view');
            },

            copyCode: () => {
                navigator.clipboard.writeText(viewId);
                Swal.fire({toast: true, position: 'top', icon: 'success', title: '‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡πÅ‡∏•‡πâ‡∏ß!', showConfirmButton: false, timer: 1500});
            },

            searchRecipe: async () => {
                const code = document.getElementById('search-inp').value.trim();
                if(code.length < 3) return;
                try {
                    Swal.showLoading();
                    const s = await getDoc(doc(db, "recipes", code));
                    Swal.close();
                    if(s.exists()) App.openView(code, false, s.data());
                    else Swal.fire('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', '‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');
                } catch(e) { console.log(e); }
            },

            editCurrent: () => {
                const r = recipes.find(x => x.id === viewId);
                if(!r) return;
                editId = viewId;
                document.getElementById('form-title').innerText = "‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏π‡∏ï‡∏£ üìù";
                document.getElementById('inp-name').value = r.name;
                document.getElementById('inp-best').checked = r.isBest;
                document.getElementById('ing-list').innerHTML = "";
                r.ingredients.forEach(i => App.addIngRow(i));
                App.calcTotal();
                App.nav('form');
            },

            deleteCurrent: () => {
                Swal.fire({
                    title: '‡∏•‡∏ö‡∏™‡∏π‡∏ï‡∏£?', icon: 'warning',
                    showCancelButton: true, confirmButtonText: '‡∏•‡∏ö‡πÄ‡∏•‡∏¢', confirmButtonColor: '#ef4444'
                }).then(async r => {
                    if(r.isConfirmed) {
                        await deleteDoc(doc(db, "recipes", viewId));
                        App.loadData();
                        App.nav('dashboard');
                    }
                })
            }
        };

        App.init();
    </script>
</body>
</html>
