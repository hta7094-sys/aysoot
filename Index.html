<!DOCTYPE html>
<html lang="th" data-theme="cupcake">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aysoot - คลังสูตรลับ เเบบไม่อร่อย</title>
    
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.6.0/dist/full.min.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        body {
            font-family: 'Kanit', sans-serif;
            background-image: url('https://images.unsplash.com/photo-1556910103-1c02745a30bf?q=80&w=2070&auto=format&fit=crop');
            background-size: cover;
            background-attachment: fixed;
            background-position: center;
        }
        .glass-box {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
        }
        .slide-up { animation: slideUp 0.5s ease-out; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="min-h-screen">

    <div class="navbar glass-box sticky top-0 z-50 px-4 md:px-8 text-slate-800">
        <div class="flex-1">
            <a onclick="app.showHome()" class="btn btn-ghost text-2xl font-bold text-orange-600 gap-2">
                <i class="fa-solid fa-cookie-bite"></i> Aysoot
            </a>
        </div>
        <div class="flex-none gap-2">
            <div id="guest-menu" class="hidden">
                <button onclick="app.toggleAuthModal('login')" class="btn btn-ghost">เข้าสู่ระบบ</button>
                <button onclick="app.toggleAuthModal('register')" class="btn btn-primary text-white rounded-full px-6">สมัครสมาชิก</button>
            </div>
            <div id="user-menu" class="hidden flex items-center gap-4">
                <div class="hidden md:block text-sm font-semibold text-orange-800" id="user-email-display"></div>
                <button onclick="app.showCreateModal()" class="btn btn-warning text-white btn-sm md:btn-md gap-2 rounded-full shadow-lg hover:scale-105 transition">
                    <i class="fa-solid fa-plus"></i> สร้างสูตรใหม่
                </button>
                <div class="dropdown dropdown-end">
                    <div tabindex="0" role="button" class="btn btn-ghost btn-circle avatar bg-orange-200">
                        <div class="w-10 rounded-full flex items-center justify-center pt-2 text-xl text-orange-600">
                            <i class="fa-solid fa-user-chef"></i>
                        </div>
                    </div>
                    <ul tabindex="0" class="mt-3 z-[1] p-2 shadow menu menu-sm dropdown-content bg-base-100 rounded-box w-52">
                        <li><a onclick="app.showMyRecipes()">สูตรของฉัน</a></li>
                        <li><a onclick="app.logout()" class="text-error">ออกจากระบบ</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <main id="main-container" class="container mx-auto p-4 pb-20 max-w-6xl">
        </main>

    <dialog id="auth_modal" class="modal">
        <div class="modal-box glass-box relative">
            <form method="dialog"><button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕</button></form>
            <h3 class="font-bold text-2xl text-center text-orange-600 mb-6" id="auth-title">เข้าสู่ระบบ</h3>
            <form id="auth-form" class="space-y-4">
                <label class="input input-bordered flex items-center gap-2">
                    <i class="fa-solid fa-envelope text-gray-400"></i>
                    <input type="email" id="auth-email" class="grow" placeholder="อีเมล" required />
                </label>
                <label class="input input-bordered flex items-center gap-2">
                    <i class="fa-solid fa-key text-gray-400"></i>
                    <input type="password" id="auth-pass" class="grow" placeholder="รหัสผ่าน" required />
                </label>
                <button type="submit" class="btn btn-primary w-full text-white text-lg mt-4 shadow-orange-300 shadow-lg">ยืนยัน</button>
            </form>
            <p class="text-center mt-4 text-sm cursor-pointer hover:underline text-gray-500" id="auth-switch" onclick="app.switchAuthMode()">ยังไม่มีบัญชี? สมัครสมาชิก</p>
        </div>
    </dialog>

    <dialog id="create_modal" class="modal">
        <div class="modal-box w-11/12 max-w-4xl glass-box">
            <form method="dialog"><button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕</button></form>
            <h3 class="font-bold text-2xl text-orange-600 mb-4"><i class="fa-solid fa-book-open"></i> บันทึกสูตรใหม่</h3>
            
            <div class="grid md:grid-cols-2 gap-6">
                <div class="space-y-4">
                    <div class="form-control">
                        <label class="label"><span class="label-text font-bold">ชื่อเมนู</span></label>
                        <input type="text" id="recipe-name" placeholder="เช่น แกงเขียวหวาน, เค้กส้ม" class="input input-bordered w-full focus:input-warning" />
                    </div>
                    <div class="form-control">
                        <label class="label"><span class="label-text font-bold">วิธีทำ / คำอธิบาย</span></label>
                        <textarea id="recipe-desc" class="textarea textarea-bordered h-40 focus:textarea-warning" placeholder="ขั้นตอนการทำ..."></textarea>
                    </div>
                </div>

                <div class="bg-orange-50/50 p-4 rounded-xl border border-orange-100">
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-bold text-orange-800">วัตถุดิบ & เครื่องปรุง</span>
                        <button onclick="app.addIngredientRow()" class="btn btn-xs btn-outline btn-warning">+ เพิ่มรายการ</button>
                    </div>
                    <div id="ingredient-list" class="space-y-2 max-h-[300px] overflow-y-auto pr-2 custom-scroll">
                        </div>
                </div>
            </div>

            <div class="modal-action">
                <button onclick="app.saveRecipe()" class="btn btn-primary text-white w-full md:w-auto px-8"><i class="fa-solid fa-save"></i> บันทึกสูตร & รับรหัสลับ</button>
            </div>
        </div>
    </dialog>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, query, where, getDocs, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Your Config
        const firebaseConfig = {
            apiKey: "AIzaSyDVS3zsJSeqOs5Wwpkj-DNbN1vhfc2_3LE",
            authDomain: "aysoot.firebaseapp.com",
            projectId: "aysoot",
            storageBucket: "aysoot.firebasestorage.app",
            messagingSenderId: "56310141842",
            appId: "1:56310141842:web:a08f702a98a39a0eb7274b",
            measurementId: "G-SCDYFZ7TLP"
        };

        const fbApp = initializeApp(firebaseConfig);
        const auth = getAuth(fbApp);
        const db = getFirestore(fbApp);

        // --- Templates ---
        const templates = {
            home: () => `
                <div class="text-center py-20 slide-up">
                    <h1 class="text-5xl md:text-7xl font-bold text-white drop-shadow-md mb-6">Aysoot Recipe</h1>
                    <p class="text-xl text-white/90 mb-10 font-light">พื้นที่ของคนรักการทำอาหาร จดบันทึกสูตรลับ และแบ่งปันด้วยรหัส</p>
                    
                    <div class="glass-box max-w-2xl mx-auto p-4 rounded-full flex shadow-2xl transform hover:scale-[1.02] transition">
                        <input id="search-code" type="text" placeholder="กรอกรหัสสูตร (เช่น X9K2P)" class="flex-1 bg-transparent px-6 text-xl outline-none placeholder-gray-500 font-bold uppercase text-slate-700">
                        <button onclick="app.searchRecipe()" class="btn btn-primary rounded-full px-8 text-white text-lg">ค้นหา</button>
                    </div>

                    <div id="search-result" class="mt-12 max-w-4xl mx-auto text-left"></div>
                </div>
            `,
            recipeCard: (data, isOwner) => `
                <div class="glass-box rounded-2xl p-6 mb-6 relative hover:shadow-xl transition border-l-8 border-orange-400 slide-up">
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="badge badge-warning text-white font-bold p-3 mb-2 text-lg tracking-widest cursor-pointer" onclick="app.copyCode('${data.id}')" title="คลิกเพื่อคัดลอก">
                                <i class="fa-solid fa-key mr-2"></i> ${data.id}
                            </div>
                            <h2 class="text-3xl font-bold text-slate-800">${data.name}</h2>
                            <p class="text-sm text-gray-500 mt-1">โดย: ${data.ownerEmail.split('@')[0]}</p>
                        </div>
                        ${isOwner ? `
                        <div class="dropdown dropdown-end">
                            <div tabindex="0" role="button" class="btn btn-ghost btn-circle text-gray-500"><i class="fa-solid fa-ellipsis-vertical"></i></div>
                            <ul tabindex="0" class="dropdown-content z-[1] menu p-2 shadow bg-base-100 rounded-box w-52">
                                <li><a onclick="app.deleteRecipe('${data.id}')" class="text-red-500"><i class="fa-solid fa-trash"></i> ลบสูตร</a></li>
                            </ul>
                        </div>` : ''}
                    </div>

                    <div class="divider"></div>

                    <div class="grid md:grid-cols-3 gap-6">
                        <div class="md:col-span-1 bg-white/50 p-4 rounded-xl">
                            <h3 class="font-bold text-lg text-orange-700 mb-3"><i class="fa-solid fa-basket-shopping"></i> วัตถุดิบ</h3>
                            <ul class="space-y-2 text-sm">
                                ${data.ingredients.map(ing => `
                                    <li class="flex justify-between border-b border-gray-200 pb-1">
                                        <span>${ing.name}</span>
                                        <span class="font-bold text-orange-600">${ing.qty} ${ing.unit}</span>
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                        <div class="md:col-span-2">
                            <h3 class="font-bold text-lg text-orange-700 mb-3"><i class="fa-solid fa-fire-burner"></i> วิธีทำ</h3>
                            <p class="whitespace-pre-line text-slate-700 leading-relaxed">${data.desc || 'ไม่มีรายละเอียด'}</p>
                        </div>
                    </div>
                </div>
            `,
            myRecipes: (list) => `
                <div class="slide-up">
                    <h2 class="text-3xl font-bold text-white drop-shadow mb-6"><i class="fa-solid fa-book"></i> สมุดจดสูตรของฉัน</h2>
                    ${list.length === 0 ? 
                        `<div class="glass-box p-10 rounded-2xl text-center text-gray-500">
                            <i class="fa-solid fa-circle-plus text-6xl text-orange-300 mb-4"></i><br>ยังไม่มีสูตร<br>กดปุ่ม "สร้างสูตรใหม่" ด้านบนเพื่อเริ่มจด
                        </div>` 
                        : list}
                </div>
            `,
            compare: () => `
                <div class="glass-box rounded-2xl p-8 slide-up">
                    <h2 class="text-3xl font-bold text-center text-orange-600 mb-8">โหมดเปรียบเทียบสูตร</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div id="compare-a" class="border-r-0 md:border-r border-gray-300 pr-0 md:pr-4">
                            <input id="code-a" type="text" placeholder="รหัสสูตรที่ 1" class="input input-bordered w-full mb-4">
                            <button onclick="app.fetchCompare('code-a', 'res-a')" class="btn btn-outline btn-warning w-full">โหลดข้อมูล</button>
                            <div id="res-a" class="mt-4 min-h-[200px]"></div>
                        </div>
                        <div id="compare-b" class="pl-0 md:pl-4">
                            <input id="code-b" type="text" placeholder="รหัสสูตรที่ 2" class="input input-bordered w-full mb-4">
                            <button onclick="app.fetchCompare('code-b', 'res-b')" class="btn btn-outline btn-warning w-full">โหลดข้อมูล</button>
                            <div id="res-b" class="mt-4 min-h-[200px]"></div>
                        </div>
                    </div>
                </div>
            `
        };

        // --- App Logic ---
        window.app = {
            user: null,
            authMode: 'login',

            init: () => {
                onAuthStateChanged(auth, (user) => {
                    app.user = user;
                    app.updateUI();
                    if(user) app.showMyRecipes();
                    else app.showHome();
                });
            },

            updateUI: () => {
                const guestMenu = document.getElementById('guest-menu');
                const userMenu = document.getElementById('user-menu');
                if (app.user) {
                    guestMenu.classList.add('hidden');
                    userMenu.classList.remove('hidden');
                    userMenu.classList.add('flex');
                    document.getElementById('user-email-display').innerText = `เชฟ: ${app.user.email}`;
                } else {
                    guestMenu.classList.remove('hidden');
                    userMenu.classList.add('hidden');
                    userMenu.classList.remove('flex');
                }
            },

            // Navigation
            showHome: () => {
                document.getElementById('main-container').innerHTML = templates.home() + `<div class="mt-10">${templates.compare()}</div>`;
            },
            
            showMyRecipes: async () => {
                if(!app.user) return;
                const q = query(collection(db, "recipes"), where("ownerId", "==", app.user.uid));
                const snapshot = await getDocs(q);
                const listHtml = snapshot.docs.map(doc => templates.recipeCard({id: doc.id, ...doc.data()}, true)).join('');
                document.getElementById('main-container').innerHTML = templates.myRecipes(listHtml);
            },

            // Auth Functions
            toggleAuthModal: (mode) => {
                app.authMode = mode;
                const title = mode === 'login' ? 'เข้าสู่ระบบ' : 'สมัครสมาชิก';
                const switchText = mode === 'login' ? 'ยังไม่มีบัญชี? สมัครสมาชิก' : 'มีบัญชีแล้ว? เข้าสู่ระบบ';
                
                document.getElementById('auth-title').innerText = title;
                document.getElementById('auth-switch').innerText = switchText;
                document.getElementById('auth_modal').showModal();
            },

            switchAuthMode: () => app.toggleAuthModal(app.authMode === 'login' ? 'register' : 'login'),

            handleAuth: async (e) => {
                e.preventDefault();
                const email = document.getElementById('auth-email').value;
                const pass = document.getElementById('auth-pass').value;
                const modal = document.getElementById('auth_modal');

                try {
                    if (app.authMode === 'login') {
                        await signInWithEmailAndPassword(auth, email, pass);
                        Swal.fire({icon: 'success', title: 'ยินดีต้อนรับกลับ!', timer: 1500, showConfirmButton: false});
                    } else {
                        await createUserWithEmailAndPassword(auth, email, pass);
                        Swal.fire({icon: 'success', title: 'สมัครสมาชิกสำเร็จ!', text: 'เริ่มจดสูตรได้เลย', timer: 1500, showConfirmButton: false});
                    }
                    modal.close();
                } catch (err) {
                    Swal.fire({icon: 'error', title: 'ผิดพลาด', text: err.message});
                }
            },

            logout: () => {
                Swal.fire({
                    title: 'ออกจากระบบ?',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'ใช่',
                    cancelButtonText: 'ไม่'
                }).then((result) => {
                    if (result.isConfirmed) signOut(auth);
                });
            },

            // Recipe Functions
            showCreateModal: () => {
                document.getElementById('recipe-name').value = '';
                document.getElementById('recipe-desc').value = '';
                document.getElementById('ingredient-list').innerHTML = '';
                app.addIngredientRow(); // Add first row
                document.getElementById('create_modal').showModal();
            },

            addIngredientRow: () => {
                const div = document.createElement('div');
                div.className = 'flex gap-2 animate-fade-in';
                div.innerHTML = `
                    <input type="text" placeholder="วัตถุดิบ (เช่น แป้ง)" class="input input-sm input-bordered flex-1 ing-name">
                    <input type="text" placeholder="ปริมาณ" class="input input-sm input-bordered w-20 ing-qty">
                    <input type="text" placeholder="หน่วย" class="input input-sm input-bordered w-20 ing-unit">
                    <button onclick="this.parentElement.remove()" class="btn btn-sm btn-ghost text-red-500"><i class="fa-solid fa-xmark"></i></button>
                `;
                document.getElementById('ingredient-list').appendChild(div);
            },

            saveRecipe: async () => {
                const name = document.getElementById('recipe-name').value;
                const desc = document.getElementById('recipe-desc').value;
                const ingredients = [];
                
                document.querySelectorAll('#ingredient-list > div').forEach(row => {
                    const n = row.querySelector('.ing-name').value;
                    const q = row.querySelector('.ing-qty').value;
                    const u = row.querySelector('.ing-unit').value;
                    if(n) ingredients.push({name: n, qty: q, unit: u});
                });

                if(!name || ingredients.length === 0) {
                    return Swal.fire('ข้อมูลไม่ครบ', 'กรุณาใส่ชื่อเมนูและวัตถุดิบอย่างน้อย 1 อย่าง', 'warning');
                }

                const code = Math.random().toString(36).substring(2, 8).toUpperCase(); // Gen Code e.g. 5XY9A
                
                try {
                    await setDoc(doc(db, "recipes", code), {
                        name, desc, ingredients,
                        ownerId: app.user.uid,
                        ownerEmail: app.user.email,
                        createdAt: serverTimestamp()
                    });
                    
                    document.getElementById('create_modal').close();
                    Swal.fire({
                        title: 'บันทึกสำเร็จ!',
                        html: `รหัสสูตรของคุณคือ: <h1 class="text-4xl font-bold text-orange-600 my-2">${code}</h1>(ส่งรหัสนี้ให้เพื่อนดูได้เลย)`,
                        icon: 'success'
                    });
                    app.showMyRecipes();
                } catch (err) {
                    console.error(err);
                    Swal.fire('Error', 'บันทึกไม่สำเร็จ', 'error');
                }
            },

            deleteRecipe: async (id) => {
                Swal.fire({
                    title: 'ยืนยันการลบ?',
                    text: "ลบแล้วกู้คืนไม่ได้นะ!",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    confirmButtonText: 'ลบเลย'
                }).then(async (result) => {
                    if (result.isConfirmed) {
                        await deleteDoc(doc(db, "recipes", id));
                        app.showMyRecipes();
                        Swal.fire('ลบแล้ว!', '', 'success');
                    }
                });
            },

            // Search & Compare
            searchRecipe: async () => {
                const code = document.getElementById('search-code').value.trim().toUpperCase();
                if(!code) return;
                
                const resDiv = document.getElementById('search-result');
                resDiv.innerHTML = '<span class="loading loading-spinner text-warning"></span>';

                const docSnap = await getDoc(doc(db, "recipes", code));
                if (docSnap.exists()) {
                    resDiv.innerHTML = templates.recipeCard({id: code, ...docSnap.data()}, false);
                } else {
                    resDiv.innerHTML = `<div class="alert alert-error">ไม่พบสูตรจากรหัส ${code}</div>`;
                }
            },

            fetchCompare: async (inputId, outputId) => {
                const code = document.getElementById(inputId).value.trim().toUpperCase();
                const output = document.getElementById(outputId);
                if(!code) return;

                const docSnap = await getDoc(doc(db, "recipes", code));
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    output.innerHTML = `
                        <div class="bg-white/80 p-4 rounded-xl shadow-inner">
                            <h3 class="font-bold text-xl text-orange-700">${data.name}</h3>
                            <div class="divider my-1"></div>
                            <ul class="text-sm space-y-1">
                                ${data.ingredients.map(ing => `<li class="flex justify-between"><span>${ing.name}</span> <span class="font-bold">${ing.qty} ${ing.unit}</span></li>`).join('')}
                            </ul>
                        </div>
                    `;
                } else {
                    output.innerHTML = `<p class="text-red-500 text-center">ไม่พบข้อมูล</p>`;
                }
            },

            copyCode: (code) => {
                navigator.clipboard.writeText(code);
                const Toast = Swal.mixin({
                    toast: true, position: 'top-end', showConfirmButton: false, timer: 2000
                });
                Toast.fire({ icon: 'success', title: 'คัดลอกรหัสแล้ว: ' + code });
            }
        };

        document.getElementById('auth-form').addEventListener('submit', app.handleAuth);
        app.init();
    </script>
</body>
</html>
