<!DOCTYPE html>
<html lang="th" data-theme="lofi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Aysoot - The Culinary Archive</title>
    
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.6.0/dist/full.min.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@200;300;400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>

    <style>
        :root {
            --primary: #FF7E5F;
            --secondary: #FEB47B;
            --glass: rgba(255, 255, 255, 0.75);
            --glass-border: rgba(255, 255, 255, 0.4);
        }

        body {
            font-family: 'Prompt', sans-serif;
            margin: 0;
            overflow-x: hidden;
            background-color: #f3f4f6;
        }

        /* Animated Background */
        .bg-animate {
            position: fixed;
            top: 0; left: 0; width: 100vw; height: 100vh;
            z-index: -1;
            background: linear-gradient(45deg, #FF9A9E 0%, #FECFEEF 99%, #FECFEEF 100%); 
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
        }
        
        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Floating Blobs */
        .blob {
            position: absolute;
            filter: blur(50px);
            z-index: -1;
            opacity: 0.6;
            animation: float 10s infinite alternate;
        }
        .blob-1 { top: 10%; left: 10%; width: 300px; height: 300px; background: #ffecd2; border-radius: 40% 60% 70% 30%; }
        .blob-2 { bottom: 20%; right: 10%; width: 250px; height: 250px; background: #fcb69f; border-radius: 60% 40% 30% 70%; }

        @keyframes float { from { transform: translate(0, 0); } to { transform: translate(20px, -20px); } }

        /* Glassmorphism Card */
        .glass-card {
            background: var(--glass);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
        }

        .btn-gradient {
            background: linear-gradient(to right, #FF7E5F, #FEB47B);
            border: none;
            color: white;
            transition: transform 0.2s;
        }
        .btn-gradient:active { transform: scale(0.95); }

        /* Transition */
        .fade-in-up { animation: fadeInUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards; opacity: 0; transform: translateY(20px); }
        @keyframes fadeInUp { to { opacity: 1; transform: translateY(0); } }

        /* Custom Scrollbar */
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #FF7E5F; border-radius: 4px; }
    </style>
</head>
<body class="text-slate-800">

    <div class="bg-animate"></div>
    <div class="blob blob-1"></div>
    <div class="blob blob-2"></div>

    <div class="fixed top-4 left-4 right-4 z-50">
        <div class="glass-card px-4 py-3 flex justify-between items-center max-w-6xl mx-auto shadow-lg">
            <div onclick="app.renderHome()" class="flex items-center gap-2 cursor-pointer">
                <div class="bg-white w-10 h-10 rounded-full flex items-center justify-center text-orange-500 shadow-md">
                    <i class="fa-solid fa-utensils"></i>
                </div>
                <h1 class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-orange-600 to-orange-400">Aysoot</h1>
            </div>
            
            <div class="hidden md:flex gap-4 items-center" id="desktop-menu">
                </div>

            <button class="md:hidden btn btn-circle btn-ghost" onclick="document.getElementById('mobile-drawer').checked = true">
                <i class="fa-solid fa-bars text-xl"></i>
            </button>
        </div>
    </div>

    <div class="drawer drawer-end z-50">
        <input id="mobile-drawer" type="checkbox" class="drawer-toggle" />
        <div class="drawer-side">
            <label for="mobile-drawer" aria-label="close sidebar" class="drawer-overlay"></label>
            <ul class="menu p-4 w-64 min-h-full bg-white/95 text-base-content pt-20" id="mobile-menu-list">
                </ul>
        </div>
    </div>

    <main id="app" class="container mx-auto px-4 pt-28 pb-20 max-w-5xl min-h-screen">
        </main>

    <button id="fab-create" onclick="app.openCreateModal()" class="hidden fixed bottom-6 right-6 w-14 h-14 bg-gradient-to-r from-orange-500 to-pink-500 rounded-full text-white shadow-2xl items-center justify-center text-2xl z-40 hover:scale-110 transition-transform">
        <i class="fa-solid fa-plus"></i>
    </button>

    <dialog id="modal_auth" class="modal modal-bottom sm:modal-middle">
        <div class="modal-box glass-card p-8">
            <h3 class="font-bold text-2xl text-center mb-6 bg-clip-text text-transparent bg-gradient-to-r from-orange-600 to-orange-400" id="auth-title">เข้าสู่ระบบ</h3>
            <form id="auth-form" class="space-y-4">
                <div class="relative">
                    <i class="fa-solid fa-envelope absolute left-4 top-4 text-gray-400"></i>
                    <input type="email" id="email" placeholder="อีเมล" class="input input-bordered w-full pl-10 rounded-xl bg-white/50 focus:bg-white transition" required />
                </div>
                <div class="relative">
                    <i class="fa-solid fa-key absolute left-4 top-4 text-gray-400"></i>
                    <input type="password" id="password" placeholder="รหัสผ่าน" class="input input-bordered w-full pl-10 rounded-xl bg-white/50 focus:bg-white transition" required />
                </div>
                <button type="submit" class="btn btn-gradient w-full rounded-xl text-lg shadow-lg mt-4">ยืนยัน</button>
            </form>
            <p class="text-center mt-6 text-sm text-gray-500" onclick="app.toggleAuthMode()">
                <span id="auth-switch-text" class="cursor-pointer hover:text-orange-600 transition">ยังไม่มีบัญชี? สมัครสมาชิก</span>
            </p>
            <form method="dialog" class="modal-backdrop">
                <button class="absolute top-4 right-4 btn btn-sm btn-circle btn-ghost">✕</button>
            </form>
        </div>
    </dialog>

    <dialog id="modal_create" class="modal modal-bottom sm:modal-middle">
        <div class="modal-box w-11/12 max-w-3xl glass-card p-0 overflow-hidden">
            <div class="p-6 bg-white/50 backdrop-blur-sm border-b sticky top-0 z-10 flex justify-between items-center">
                <h3 class="font-bold text-xl text-orange-600"><i class="fa-solid fa-pen-nib"></i> บันทึกสูตรใหม่</h3>
                <form method="dialog"><button class="btn btn-sm btn-circle btn-ghost">✕</button></form>
            </div>
            
            <div class="p-6 space-y-6 max-h-[70vh] overflow-y-auto custom-scroll">
                <div class="form-control">
                    <label class="label font-bold text-gray-600">ชื่อเมนูอาหาร</label>
                    <input type="text" id="recipe-name" placeholder="เช่น สปาเก็ตตี้คาโบนาร่า" class="input input-bordered w-full rounded-xl focus:border-orange-400" />
                </div>

                <div class="bg-orange-50/50 p-4 rounded-2xl border border-orange-100">
                    <div class="flex justify-between items-center mb-3">
                        <label class="font-bold text-gray-600">วัตถุดิบ & ส่วนผสม</label>
                        <button onclick="app.addIngredient()" class="btn btn-xs btn-circle btn-outline btn-warning"><i class="fa-solid fa-plus"></i></button>
                    </div>
                    <div id="ingredient-list" class="space-y-2">
                        </div>
                </div>

                <div class="form-control">
                    <label class="label font-bold text-gray-600">วิธีทำ</label>
                    <textarea id="recipe-steps" class="textarea textarea-bordered h-32 rounded-xl focus:border-orange-400 leading-relaxed" placeholder="1. ต้มน้ำให้เดือด..."></textarea>
                </div>
            </div>

            <div class="p-4 bg-white/80 border-t flex justify-end">
                <button onclick="app.saveRecipe()" class="btn btn-gradient w-full md:w-auto rounded-xl px-8 shadow-lg">บันทึกสูตร</button>
            </div>
        </div>
    </dialog>

    <datalist id="common-ingredients">
        <option value="เกลือ"><option value="น้ำตาลทราย"><option value="พริกไทยดำ"><option value="น้ำปลา"><option value="ซีอิ๊วขาว">
        <option value="กระเทียม"><option value="หอมหัวใหญ่"><option value="ไข่ไก่"><option value="หมูสับ"><option value="นมสด">
    </datalist>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, query, where, getDocs, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyDVS3zsJSeqOs5Wwpkj-DNbN1vhfc2_3LE",
            authDomain: "aysoot.firebaseapp.com",
            projectId: "aysoot",
            storageBucket: "aysoot.firebasestorage.app",
            messagingSenderId: "56310141842",
            appId: "1:56310141842:web:a08f702a98a39a0eb7274b",
            measurementId: "G-SCDYFZ7TLP"
        };

        const fbApp = initializeApp(firebaseConfig);
        const auth = getAuth(fbApp);
        const db = getFirestore(fbApp);

        // --- UI Logic & Templates ---
        window.app = {
            user: null,
            authMode: 'login',

            // UI Templates
            views: {
                home: () => `
                    <div class="text-center mt-8 md:mt-16 fade-in-up">
                        <span class="inline-block py-1 px-3 rounded-full bg-white/60 border border-white text-orange-600 text-xs font-bold mb-4 shadow-sm">Welcome to Aysoot</span>
                        <h1 class="text-4xl md:text-6xl font-bold mb-6 leading-tight text-slate-800 drop-shadow-sm">
                            ค้นพบและแบ่งปัน <br><span class="text-transparent bg-clip-text bg-gradient-to-r from-orange-500 to-pink-500">สูตรลับแสนอร่อย</span>
                        </h1>
                        <p class="text-slate-600 mb-10 max-w-lg mx-auto font-light text-sm md:text-base">
                            พื้นที่สำหรับนักปรุงอาหาร บันทึกสูตรลับของคุณ ค้นหาส่วนผสม และส่งต่อความอร่อยผ่านรหัสลับ
                        </p>
                        
                        <div class="relative max-w-xl mx-auto group">
                            <div class="absolute -inset-1 bg-gradient-to-r from-orange-400 to-pink-400 rounded-full blur opacity-25 group-hover:opacity-50 transition duration-200"></div>
                            <div class="relative flex bg-white rounded-full shadow-xl p-2">
                                <input id="home-search" type="text" placeholder="กรอกรหัสสูตร (เช่น AY59X)" class="flex-1 pl-6 bg-transparent outline-none text-lg text-slate-700 placeholder-gray-400 uppercase font-bold">
                                <button onclick="app.searchRecipe('home-search', 'home-result')" class="bg-gradient-to-r from-orange-500 to-pink-500 text-white rounded-full w-12 h-12 flex items-center justify-center hover:scale-105 transition shadow-md">
                                    <i class="fa-solid fa-search"></i>
                                </button>
                            </div>
                        </div>

                        <div id="home-result" class="mt-8 text-left max-w-2xl mx-auto"></div>

                        <div class="grid grid-cols-2 md:grid-cols-3 gap-4 mt-16">
                            <div onclick="app.renderCompare()" class="glass-card p-6 text-center hover:-translate-y-2 transition cursor-pointer">
                                <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center text-blue-500 mx-auto mb-3"><i class="fa-solid fa-scale-balanced"></i></div>
                                <h3 class="font-bold">เปรียบเทียบ</h3>
                                <p class="text-xs text-gray-500 mt-1">เทียบปริมาณวัตถุดิบ</p>
                            </div>
                             <div class="glass-card p-6 text-center hover:-translate-y-2 transition cursor-pointer opacity-80">
                                <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center text-green-500 mx-auto mb-3"><i class="fa-solid fa-globe"></i></div>
                                <h3 class="font-bold">ทั่วโลก</h3>
                                <p class="text-xs text-gray-500 mt-1">วัตถุดิบหลากหลาย</p>
                            </div>
                            <div class="glass-card p-6 text-center hover:-translate-y-2 transition cursor-pointer opacity-80">
                                <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center text-purple-500 mx-auto mb-3"><i class="fa-solid fa-lock"></i></div>
                                <h3 class="font-bold">ส่วนตัว</h3>
                                <p class="text-xs text-gray-500 mt-1">แก้ได้เฉพาะเจ้าของ</p>
                            </div>
                        </div>
                    </div>
                `,
                dashboard: (cardsHtml) => `
                    <div class="fade-in-up">
                        <div class="flex justify-between items-end mb-6">
                            <div>
                                <h2 class="text-3xl font-bold text-slate-800">สูตรของฉัน</h2>
                                <p class="text-gray-500 text-sm">จัดการสูตรลับของคุณได้ที่นี่</p>
                            </div>
                            <button onclick="app.openCreateModal()" class="hidden md:flex btn btn-gradient btn-sm rounded-full gap-2 shadow-md">
                                <i class="fa-solid fa-plus"></i> เพิ่มสูตร
                            </button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 pb-20">
                            ${cardsHtml || `
                                <div class="col-span-full py-16 text-center text-gray-400 glass-card">
                                    <i class="fa-solid fa-utensils text-4xl mb-4 opacity-30"></i>
                                    <p>ยังไม่มีสูตรอาหาร กดปุ่ม + เพื่อเริ่มสร้าง</p>
                                </div>
                            `}
                        </div>
                    </div>
                `,
                compare: () => `
                    <div class="fade-in-up max-w-4xl mx-auto">
                        <h2 class="text-3xl font-bold text-center mb-8 text-slate-800">เปรียบเทียบสูตร</h2>
                        <div class="flex flex-col md:flex-row gap-6">
                            <div class="flex-1 glass-card p-6">
                                <div class="join w-full mb-4">
                                    <input id="cmp-code-a" class="input input-bordered join-item w-full bg-white/50" placeholder="รหัสสูตร A"/>
                                    <button onclick="app.fetchRecipe('cmp-code-a', 'cmp-res-a', true)" class="btn btn-warning join-item text-white"><i class="fa-solid fa-search"></i></button>
                                </div>
                                <div id="cmp-res-a" class="min-h-[200px] flex items-center justify-center text-gray-400 border-2 border-dashed border-gray-300 rounded-xl bg-white/30">
                                    รอข้อมูล...
                                </div>
                            </div>
                             <div class="flex items-center justify-center">
                                <div class="w-12 h-12 bg-slate-800 text-white rounded-full flex items-center justify-center font-bold shadow-lg z-10">VS</div>
                            </div>
                            <div class="flex-1 glass-card p-6">
                                <div class="join w-full mb-4">
                                    <input id="cmp-code-b" class="input input-bordered join-item w-full bg-white/50" placeholder="รหัสสูตร B"/>
                                    <button onclick="app.fetchRecipe('cmp-code-b', 'cmp-res-b', true)" class="btn btn-secondary join-item text-white"><i class="fa-solid fa-search"></i></button>
                                </div>
                                <div id="cmp-res-b" class="min-h-[200px] flex items-center justify-center text-gray-400 border-2 border-dashed border-gray-300 rounded-xl bg-white/30">
                                    รอข้อมูล...
                                </div>
                            </div>
                        </div>
                    </div>
                `
            },

            // --- Main Logic ---
            init: () => {
                onAuthStateChanged(auth, (user) => {
                    app.user = user;
                    app.renderNav();
                    if(user) {
                        app.renderDashboard();
                        document.getElementById('fab-create').classList.remove('hidden');
                        document.getElementById('fab-create').classList.add('flex');
                    } else {
                        app.renderHome();
                        document.getElementById('fab-create').classList.add('hidden');
                        document.getElementById('fab-create').classList.remove('flex');
                    }
                });

                // Init first ingredient row
                app.addIngredient();
            },

            renderNav: () => {
                const desktopMenu = document.getElementById('desktop-menu');
                const mobileMenu = document.getElementById('mobile-menu-list');
                
                let links = '';
                if(app.user) {
                    links = `
                        <li><a onclick="app.renderDashboard()">สูตรของฉัน</a></li>
                        <li><a onclick="app.renderCompare()">เปรียบเทียบ</a></li>
                        <li><a onclick="app.logout()" class="text-red-500 font-bold">ออกจากระบบ</a></li>
                    `;
                    desktopMenu.innerHTML = `
                        <button onclick="app.renderDashboard()" class="btn btn-ghost btn-sm">สูตรของฉัน</button>
                        <button onclick="app.renderCompare()" class="btn btn-ghost btn-sm">เปรียบเทียบ</button>
                        <div class="dropdown dropdown-end ml-2">
                            <div tabindex="0" role="button" class="avatar placeholder cursor-pointer">
                                <div class="bg-orange-500 text-white rounded-full w-8 h-8 flex items-center justify-center">
                                    <span>${app.user.email[0].toUpperCase()}</span>
                                </div>
                            </div>
                            <ul tabindex="0" class="dropdown-content z-[1] menu p-2 shadow bg-base-100 rounded-box w-52">
                                <li class="menu-title text-xs text-gray-400 px-4 py-2">${app.user.email}</li>
                                <li><a onclick="app.logout()" class="text-red-500">ออกจากระบบ</a></li>
                            </ul>
                        </div>
                    `;
                } else {
                    links = `
                        <li><a onclick="app.renderHome()">หน้าแรก</a></li>
                        <li><a onclick="app.renderCompare()">เปรียบเทียบ</a></li>
                        <div class="divider my-1"></div>
                        <li><a onclick="app.openAuth('login')">เข้าสู่ระบบ</a></li>
                        <li><a onclick="app.openAuth('register')" class="active:bg-orange-500">สมัครสมาชิก</a></li>
                    `;
                    desktopMenu.innerHTML = `
                        <button onclick="app.renderCompare()" class="btn btn-ghost btn-sm">เปรียบเทียบ</button>
                        <button onclick="app.openAuth('login')" class="btn btn-ghost btn-sm">เข้าสู่ระบบ</button>
                        <button onclick="app.openAuth('register')" class="btn btn-gradient btn-sm rounded-full px-6 shadow-md">สมัครสมาชิก</button>
                    `;
                }
                mobileMenu.innerHTML = links;
            },

            // Navigation Renders
            renderHome: () => document.getElementById('app').innerHTML = app.views.home(),
            renderCompare: () => {
                document.getElementById('app').innerHTML = app.views.compare();
                document.getElementById('mobile-drawer').checked = false; // Close drawer
            },
            
            renderDashboard: async () => {
                document.getElementById('mobile-drawer').checked = false;
                document.getElementById('app').innerHTML = `<div class="text-center mt-20"><span class="loading loading-dots loading-lg text-orange-500"></span></div>`;
                
                try {
                    const q = query(collection(db, "recipes"), where("ownerId", "==", app.user.uid));
                    const snap = await getDocs(q);
                    let html = '';
                    snap.forEach(doc => {
                        const data = doc.data();
                        html += `
                            <div class="glass-card p-5 relative group hover:shadow-xl transition duration-300">
                                <div class="absolute top-4 right-4 opacity-0 group-hover:opacity-100 transition">
                                    <button onclick="app.deleteRecipe('${doc.id}')" class="btn btn-xs btn-circle btn-error text-white"><i class="fa-solid fa-trash"></i></button>
                                </div>
                                <div class="badge badge-warning text-white font-bold mb-2 cursor-pointer shadow-sm" onclick="app.copyCode('${doc.id}')">
                                    <i class="fa-solid fa-key mr-1 text-[10px]"></i> ${doc.id}
                                </div>
                                <h3 class="text-xl font-bold text-slate-800">${data.name}</h3>
                                <p class="text-sm text-gray-500 line-clamp-2 mt-1">${data.steps}</p>
                                <div class="divider my-2"></div>
                                <div class="flex flex-wrap gap-2">
                                    ${data.ingredients.slice(0,3).map(i => `<span class="badge badge-ghost text-xs">${i.name}</span>`).join('')}
                                    ${data.ingredients.length > 3 ? `<span class="badge badge-ghost text-xs">+${data.ingredients.length-3}</span>` : ''}
                                </div>
                            </div>
                        `;
                    });
                    document.getElementById('app').innerHTML = app.views.dashboard(html);
                } catch(e) {
                    console.error(e);
                }
            },

            // Auth
            openAuth: (mode) => {
                app.authMode = mode;
                document.getElementById('mobile-drawer').checked = false;
                document.getElementById('auth-title').innerText = mode === 'login' ? 'เข้าสู่ระบบ' : 'สมัครสมาชิก';
                document.getElementById('auth-switch-text').innerText = mode === 'login' ? 'ยังไม่มีบัญชี? สมัครสมาชิก' : 'มีบัญชีแล้ว? เข้าสู่ระบบ';
                document.getElementById('modal_auth').showModal();
            },
            toggleAuthMode: () => app.openAuth(app.authMode === 'login' ? 'register' : 'login'),
            
            handleAuthSubmit: async (e) => {
                e.preventDefault();
                const email = document.getElementById('email').value;
                const pass = document.getElementById('password').value;
                try {
                    if(app.authMode === 'login') await signInWithEmailAndPassword(auth, email, pass);
                    else await createUserWithEmailAndPassword(auth, email, pass);
                    
                    document.getElementById('modal_auth').close();
                    Swal.fire({icon:'success', title: 'ยินดีต้อนรับ', timer: 1500, showConfirmButton: false});
                } catch(e) {
                    Swal.fire({icon:'error', title: 'เกิดข้อผิดพลาด', text: e.message});
                }
            },
            logout: () => signOut(auth),

            // CRUD & Logic
            openCreateModal: () => {
                document.getElementById('recipe-name').value = '';
                document.getElementById('recipe-steps').value = '';
                document.getElementById('ingredient-list').innerHTML = '';
                app.addIngredient();
                document.getElementById('modal_create').showModal();
            },

            addIngredient: () => {
                const div = document.createElement('div');
                div.className = "flex gap-2 animate-fade-in-up";
                div.innerHTML = `
                    <input type="text" placeholder="วัตถุดิบ" list="common-ingredients" class="input input-sm input-bordered flex-1 rounded-lg ing-name bg-white/70">
                    <input type="text" placeholder="ปริมาณ" class="input input-sm input-bordered w-20 text-center rounded-lg ing-qty bg-white/70">
                    <input type="text" placeholder="หน่วย" class="input input-sm input-bordered w-16 text-center rounded-lg ing-unit bg-white/70">
                    <button onclick="this.parentElement.remove()" class="btn btn-sm btn-ghost text-red-400"><i class="fa-solid fa-times"></i></button>
                `;
                document.getElementById('ingredient-list').appendChild(div);
            },

            saveRecipe: async () => {
                const name = document.getElementById('recipe-name').value;
                const steps = document.getElementById('recipe-steps').value;
                const ingredients = [];
                document.querySelectorAll('#ingredient-list > div').forEach(r => {
                    const n = r.querySelector('.ing-name').value;
                    const q = r.querySelector('.ing-qty').value;
                    const u = r.querySelector('.ing-unit').value;
                    if(n) ingredients.push({name: n, qty: q, unit: u});
                });

                if(!name || ingredients.length === 0) return Swal.fire('ข้อมูลไม่ครบ', 'กรุณาใส่ชื่อและวัตถุดิบ', 'warning');

                const code = Math.random().toString(36).substring(2, 7).toUpperCase();
                try {
                    await setDoc(doc(db, "recipes", code), {
                        name, steps, ingredients,
                        ownerId: app.user.uid,
                        createdAt: serverTimestamp()
                    });
                    document.getElementById('modal_create').close();
                    Swal.fire({
                        title: 'บันทึกสำเร็จ!',
                        html: `รหัสสูตรคือ: <b class="text-3xl text-orange-500 block mt-2">${code}</b>`,
                        icon: 'success'
                    });
                    app.renderDashboard();
                } catch(e) { Swal.fire('Error', e.message, 'error'); }
            },

            deleteRecipe: async (id) => {
                if((await Swal.fire({title: 'ลบสูตร?', showCancelButton: true, confirmButtonColor: '#d33'})).isConfirmed){
                    await deleteDoc(doc(db, "recipes", id));
                    app.renderDashboard();
                }
            },

            searchRecipe: async (inputId, outputId, isCompare = false) => {
                const code = document.getElementById(inputId).value.trim().toUpperCase();
                const out = document.getElementById(outputId);
                if(!code) return;

                out.innerHTML = `<div class="text-center py-4"><span class="loading loading-spinner text-orange-500"></span></div>`;
                
                try {
                    const snap = await getDoc(doc(db, "recipes", code));
                    if(snap.exists()){
                        const d = snap.data();
                        const ingHtml = d.ingredients.map(i => `
                            <div class="flex justify-between py-2 border-b border-gray-100 last:border-0">
                                <span class="text-slate-700">${i.name}</span>
                                <span class="font-bold text-orange-600">${i.qty} ${i.unit}</span>
                            </div>
                        `).join('');

                        out.innerHTML = `
                            <div class="glass-card bg-white/80 p-6 rounded-xl shadow-inner animate-fade-in-up w-full">
                                ${isCompare ? '' : `<div class="badge badge-warning text-white mb-2">CODE: ${code}</div>`}
                                <h3 class="text-2xl font-bold text-slate-800 mb-4">${d.name}</h3>
                                <div class="bg-white/60 rounded-xl p-4 mb-4">
                                    <h4 class="font-bold text-orange-500 mb-2 text-sm uppercase tracking-wide">วัตถุดิบ</h4>
                                    ${ingHtml}
                                </div>
                                ${isCompare ? '' : `
                                    <div>
                                        <h4 class="font-bold text-orange-500 mb-2 text-sm uppercase tracking-wide">วิธีทำ</h4>
                                        <p class="text-slate-600 leading-relaxed whitespace-pre-line">${d.steps}</p>
                                    </div>
                                `}
                            </div>
                        `;
                    } else {
                        out.innerHTML = `<div class="alert alert-error text-white text-sm">ไม่พบสูตรจากรหัส ${code}</div>`;
                    }
                } catch(e) { console.error(e); }
            },

            copyCode: (code) => {
                navigator.clipboard.writeText(code);
                const Toast = Swal.mixin({ toast: true, position: 'top', showConfirmButton: false, timer: 1500 });
                Toast.fire({ icon: 'success', title: 'คัดลอกรหัสแล้ว' });
            }
        };

        document.getElementById('auth-form').addEventListener('submit', app.handleAuthSubmit);
        app.init();
    </script>
</body>
</html>
