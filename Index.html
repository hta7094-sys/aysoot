<!DOCTYPE html>
<html lang="th" data-theme="pastel">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Aysoot - Social Cooking</title>
    
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.6.0/dist/full.min.css" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.10/dayjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.10/locale/th.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.10/plugin/relativeTime.min.js"></script>

    <style>
        :root {
            --glass: rgba(255, 255, 255, 0.9);
            --glass-border: rgba(255, 255, 255, 0.5);
        }

        body {
            font-family: 'Prompt', sans-serif;
            background-color: #f8fafc;
            min-height: 100vh;
            padding-bottom: 80px; /* Space for FAB */
        }

        /* Fixed Background Pattern */
        .bg-pattern {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
            background-image: radial-gradient(#FF9A9E 0.5px, transparent 0.5px), radial-gradient(#fad0c4 0.5px, #f8fafc 0.5px);
            background-size: 20px 20px;
            background-position: 0 0, 10px 10px;
            opacity: 0.6;
        }

        /* Glass Element */
        .glass-box {
            background: var(--glass);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }

        /* --- FIX SWEETALERT VISIBILITY --- */
        div:where(.swal2-container) {
            z-index: 10000 !important; /* อยู่บนสุดเสมอ */
        }
        div:where(.swal2-popup) {
            border-radius: 24px !important;
            padding: 2em !important;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2) !important;
        }
        .swal2-actions {
            margin-top: 20px !important;
        }

        /* Animation */
        .fade-enter { animation: fadeEnter 0.4s ease-out forwards; opacity: 0; transform: translateY(10px); }
        @keyframes fadeEnter { to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="text-slate-800">

    <div class="bg-pattern"></div>

    <div class="fixed top-0 left-0 right-0 z-40 p-2">
        <div class="glass-box px-4 py-3 flex justify-between items-center max-w-5xl mx-auto">
            <div onclick="app.goHome()" class="flex items-center gap-3 cursor-pointer">
                <div class="w-10 h-10 rounded-full bg-gradient-to-tr from-orange-400 to-pink-500 flex items-center justify-center text-white shadow-md">
                    <i class="fa-solid fa-utensils"></i>
                </div>
                <span class="font-bold text-lg tracking-tight">Aysoot</span>
            </div>

            <div id="nav-profile" class="hidden">
                <div class="dropdown dropdown-end">
                    <div tabindex="0" role="button" class="btn btn-ghost btn-circle avatar border border-white shadow-sm">
                        <div class="w-10 rounded-full bg-slate-200">
                            <img id="profile-img" src="https://ui-avatars.com/api/?name=User" alt="Profile" />
                        </div>
                    </div>
                    <ul tabindex="0" class="mt-3 z-[1] p-2 shadow-lg menu menu-sm dropdown-content bg-white rounded-box w-52 border border-slate-100">
                        <li class="menu-title px-4 py-2 border-b mb-2" id="menu-name">User</li>
                        <li><a onclick="app.renderMyRecipes()"><i class="fa-solid fa-book"></i> สูตรของฉัน</a></li>
                        <li><a onclick="app.openProfileModal()"><i class="fa-solid fa-user-pen"></i> แก้ไขโปรไฟล์</a></li>
                        <div class="divider my-1"></div>
                        <li><a onclick="app.logout()" class="text-red-500"><i class="fa-solid fa-right-from-bracket"></i> ออกจากระบบ</a></li>
                    </ul>
                </div>
            </div>

            <div id="nav-guest" class="hidden gap-2">
                <button onclick="app.openAuth('login')" class="btn btn-sm btn-ghost rounded-full">เข้าสู่ระบบ</button>
            </div>
        </div>
    </div>

    <main id="app-root" class="container mx-auto px-4 pt-24 max-w-3xl min-h-screen pb-24">
        </main>

    <button id="fab-create" onclick="app.openCreateModal()" class="hidden fixed bottom-6 right-6 w-14 h-14 bg-slate-800 text-white rounded-full shadow-2xl z-30 flex items-center justify-center text-2xl hover:scale-110 active:scale-95 transition-all">
        <i class="fa-solid fa-plus"></i>
    </button>

    <dialog id="modal_auth" class="modal modal-bottom sm:modal-middle">
        <div class="modal-box bg-white rounded-t-3xl sm:rounded-3xl p-8">
            <form method="dialog"><button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕</button></form>
            <h3 class="text-2xl font-bold text-center mb-6" id="auth-title">เข้าสู่ระบบ</h3>
            
            <form id="auth-form" class="space-y-4">
                <div id="field-name" class="hidden">
                    <label class="label"><span class="label-text">ชื่อที่ใช้แสดง (Display Name)</span></label>
                    <input type="text" id="inp-name" class="input input-bordered w-full rounded-xl" placeholder="เช่น เชฟกระทะเหล็ก">
                </div>
                <div>
                    <label class="label"><span class="label-text">อีเมล</span></label>
                    <input type="email" id="inp-email" class="input input-bordered w-full rounded-xl" required>
                </div>
                <div>
                    <label class="label"><span class="label-text">รหัสผ่าน</span></label>
                    <input type="password" id="inp-pass" class="input input-bordered w-full rounded-xl" required>
                </div>
                <button type="submit" class="btn btn-neutral w-full rounded-xl text-lg mt-4 shadow-lg">ยืนยัน</button>
            </form>
            
            <p class="text-center mt-6 text-sm text-gray-500 cursor-pointer hover:text-orange-500" onclick="app.toggleAuth()">
                <span id="auth-toggle-text">ยังไม่มีบัญชี? สมัครสมาชิก</span>
            </p>
        </div>
    </dialog>

    <dialog id="modal_profile" class="modal modal-bottom sm:modal-middle">
        <div class="modal-box bg-white rounded-t-3xl sm:rounded-3xl">
            <h3 class="font-bold text-lg mb-4">แก้ไขข้อมูลส่วนตัว</h3>
            <div class="space-y-4">
                <div class="flex justify-center mb-4">
                     <div class="w-20 h-20 rounded-full bg-slate-100 flex items-center justify-center text-3xl text-slate-300">
                        <i class="fa-solid fa-user"></i>
                     </div>
                </div>
                <div class="form-control">
                    <label class="label"><span class="label-text font-bold">ชื่อที่แสดง</span></label>
                    <input type="text" id="edit-name" class="input input-bordered w-full rounded-xl" />
                </div>
                <button onclick="app.saveProfile()" class="btn btn-primary w-full rounded-xl mt-4">บันทึกการเปลี่ยนแปลง</button>
            </div>
            <form method="dialog" class="modal-backdrop"><button>close</button></form>
        </div>
    </dialog>

    <dialog id="modal_create" class="modal">
        <div class="modal-box w-full h-full max-h-full max-w-full rounded-none sm:rounded-3xl sm:h-auto sm:max-w-2xl bg-slate-50 p-0 flex flex-col">
            <div class="bg-white px-4 py-3 border-b flex justify-between items-center sticky top-0 z-10 shadow-sm">
                <button class="btn btn-ghost btn-circle" onclick="modal_create.close()"><i class="fa-solid fa-chevron-left text-lg"></i></button>
                <h3 class="font-bold text-lg">จดสูตรใหม่</h3>
                <button onclick="app.saveRecipe()" class="btn btn-sm btn-neutral rounded-full px-6">บันทึก</button>
            </div>
            
            <div class="flex-1 overflow-y-auto p-5 space-y-6 pb-20">
                <div class="form-control">
                    <label class="label font-bold text-gray-500">ชื่อเมนูอาหาร</label>
                    <input type="text" id="recipe-name" class="input input-lg bg-white w-full font-bold text-xl border-none focus:outline-none placeholder-gray-300" placeholder="ใส่ชื่อเมนูที่นี่...">
                </div>

                <div class="card bg-white shadow-sm p-4">
                    <div class="flex justify-between items-center mb-4">
                        <span class="font-bold text-orange-500"><i class="fa-solid fa-basket-shopping"></i> วัตถุดิบ</span>
                        <button onclick="app.addIng()" class="btn btn-xs btn-ghost text-orange-500">+ เพิ่ม</button>
                    </div>
                    <div id="ing-list" class="space-y-3"></div>
                </div>

                <div class="form-control">
                    <label class="label font-bold text-gray-500">วิธีทำ</label>
                    <textarea id="recipe-steps" class="textarea textarea-lg bg-white w-full h-48 border-none focus:outline-none text-base leading-relaxed" placeholder="ขั้นตอนการทำ..."></textarea>
                </div>
            </div>
        </div>
    </dialog>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, query, where, getDocs, deleteDoc, updateDoc, arrayUnion, arrayRemove, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDVS3zsJSeqOs5Wwpkj-DNbN1vhfc2_3LE",
            authDomain: "aysoot.firebaseapp.com",
            projectId: "aysoot",
            storageBucket: "aysoot.firebasestorage.app",
            messagingSenderId: "56310141842",
            appId: "1:56310141842:web:a08f702a98a39a0eb7274b"
        };

        const appFire = initializeApp(firebaseConfig);
        const auth = getAuth(appFire);
        const db = getFirestore(appFire);

        // State & Helper
        window.state = { user: null, mode: 'login' };
        dayjs.locale('th');
        dayjs.extend(window.dayjs_plugin_relativeTime);

        window.app = {
            init: () => {
                onAuthStateChanged(auth, u => {
                    state.user = u;
                    app.renderNav();
                    if(u) app.renderMyRecipes();
                    else app.renderHome();
                });
            },

            // --- Navigation & UI ---
            renderNav: () => {
                const u = state.user;
                const profileNav = document.getElementById('nav-profile');
                const guestNav = document.getElementById('nav-guest');
                const fab = document.getElementById('fab-create');

                if(u) {
                    profileNav.classList.remove('hidden');
                    guestNav.classList.add('hidden');
                    fab.classList.remove('hidden');
                    fab.classList.add('flex');
                    
                    // Update Profile UI
                    document.getElementById('profile-img').src = `https://ui-avatars.com/api/?name=${u.displayName || 'User'}&background=random`;
                    document.getElementById('menu-name').textContent = u.displayName || u.email;
                } else {
                    profileNav.classList.add('hidden');
                    guestNav.classList.remove('hidden');
                    fab.classList.add('hidden');
                    fab.classList.remove('flex');
                }
            },

            goHome: () => state.user ? app.renderMyRecipes() : app.renderHome(),

            // --- Views ---
            renderHome: () => {
                document.getElementById('app-root').innerHTML = `
                    <div class="flex flex-col items-center justify-center pt-20 fade-enter text-center">
                        <div class="bg-white p-6 rounded-3xl shadow-xl mb-8 relative overflow-hidden max-w-sm w-full">
                            <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-orange-400 to-pink-500"></div>
                            <h1 class="text-4xl font-bold text-slate-800 mb-2">Aysoot</h1>
                            <p class="text-slate-500 text-sm mb-6">คอมมูนิตี้คนรักการทำอาหาร</p>
                            <div class="join w-full shadow-inner rounded-full bg-slate-100 p-1">
                                <input id="search-home" class="input input-ghost join-item w-full focus:outline-none bg-transparent" placeholder="รหัสสูตร (CODE)"/>
                                <button onclick="app.viewRecipeFromHome()" class="btn btn-circle bg-slate-800 text-white join-item"><i class="fa-solid fa-search"></i></button>
                            </div>
                        </div>
                        <p class="text-xs text-slate-400">กรุณาล็อกอินเพื่อเริ่มสร้างสูตรของคุณ</p>
                    </div>
                `;
            },

            renderMyRecipes: async () => {
                const root = document.getElementById('app-root');
                root.innerHTML = `<div class="text-center pt-20"><span class="loading loading-spinner text-primary loading-lg"></span><p class="mt-2 text-gray-400">กำลังโหลดข้อมูล...</p></div>`;

                try {
                    // FIX: ไม่ใช้ orderBy ใน query เพื่อเลี่ยงปัญหา Index Error
                    const q = query(collection(db, "recipes"), where("ownerId", "==", state.user.uid));
                    const snap = await getDocs(q);
                    
                    // Sort Client-side แทน
                    const recipes = [];
                    snap.forEach(d => recipes.push({ id: d.id, ...d.data() }));
                    recipes.sort((a, b) => b.createdAt?.seconds - a.createdAt?.seconds);

                    let html = `
                        <div class="flex justify-between items-end mb-6 fade-enter">
                            <div>
                                <h2 class="text-3xl font-bold text-slate-800">สูตรของฉัน</h2>
                                <p class="text-gray-500 text-sm">ทั้งหมด ${recipes.length} รายการ</p>
                            </div>
                        </div>
                        <div class="grid gap-4 md:grid-cols-2 pb-20">
                    `;

                    if(recipes.length === 0) {
                        html += `
                            <div class="col-span-full text-center py-20 opacity-50">
                                <i class="fa-solid fa-plate-wheat text-6xl mb-4 text-slate-300"></i>
                                <p>ยังไม่มีสูตร กดปุ่ม + เพื่อเพิ่มเลย</p>
                            </div>
                        `;
                    } else {
                        recipes.forEach(r => {
                            const views = r.views ? r.views.length : 0;
                            const likes = r.likes ? r.likes.length : 0;
                            html += `
                                <div class="bg-white rounded-2xl p-5 shadow-sm border border-slate-100 relative group fade-enter hover:shadow-md transition">
                                    <div class="flex justify-between items-start mb-3">
                                        <div class="flex gap-2 items-center">
                                            <div class="w-10 h-10 rounded-full bg-orange-50 text-orange-500 flex items-center justify-center font-bold text-lg">
                                                ${r.name[0]}
                                            </div>
                                            <div>
                                                <h3 class="font-bold text-slate-800 line-clamp-1">${r.name}</h3>
                                                <span class="text-[10px] bg-slate-100 px-2 py-0.5 rounded text-slate-500 font-mono tracking-wider">${r.id}</span>
                                            </div>
                                        </div>
                                        <div class="dropdown dropdown-end">
                                            <div tabindex="0" role="button" class="btn btn-xs btn-circle btn-ghost"><i class="fa-solid fa-ellipsis-vertical"></i></div>
                                            <ul tabindex="0" class="dropdown-content z-[1] menu p-2 shadow bg-base-100 rounded-box w-32">
                                                <li><a onclick="app.copyCode('${r.id}')" class="text-xs">คัดลอกรหัส</a></li>
                                                <li><a onclick="app.deleteRecipe('${r.id}')" class="text-error text-xs">ลบสูตร</a></li>
                                            </ul>
                                        </div>
                                    </div>
                                    
                                    <div class="flex gap-4 mt-4 pt-3 border-t border-slate-50">
                                        <div class="flex flex-col items-center w-1/2 border-r border-slate-100 cursor-pointer hover:bg-slate-50 rounded" onclick="app.viewRecipeDetails('${r.id}')">
                                            <span class="text-xs text-slate-400">เข้าชม</span>
                                            <span class="font-bold text-slate-700"><i class="fa-regular fa-eye"></i> ${views}</span>
                                        </div>
                                        <div class="flex flex-col items-center w-1/2 cursor-pointer hover:bg-pink-50 rounded" onclick="app.viewRecipeDetails('${r.id}')">
                                            <span class="text-xs text-slate-400">ถูกใจ</span>
                                            <span class="font-bold text-pink-500"><i class="fa-solid fa-heart"></i> ${likes}</span>
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                    }
                    html += '</div>';
                    root.innerHTML = html;

                } catch(e) {
                    console.error(e);
                    root.innerHTML = `<div class="alert alert-error">โหลดข้อมูลไม่สำเร็จ: ${e.message}</div>`;
                }
            },

            viewRecipeFromHome: () => {
                const code = document.getElementById('search-home').value.trim();
                if(code) app.viewRecipeDetails(code.toUpperCase());
            },

            viewRecipeDetails: async (id) => {
                if(!state.user) return app.openAuth('login');
                const root = document.getElementById('app-root');
                root.innerHTML = `<div class="text-center mt-20"><span class="loading loading-spinner text-pink-500"></span></div>`;

                try {
                    const snap = await getDoc(doc(db, "recipes", id));
                    if(!snap.exists()) {
                        Swal.fire('ไม่พบข้อมูล', 'รหัสสูตรไม่ถูกต้อง', 'error');
                        return app.renderMyRecipes();
                    }

                    const d = snap.data();
                    const isOwner = d.ownerId === state.user.uid;
                    
                    // Update View Count (ถ้าไม่ใช่เจ้าของ)
                    if(!isOwner) {
                         updateDoc(doc(db, "recipes", id), {
                            views: arrayUnion({ uid: state.user.uid, name: state.user.displayName, time: new Date().toISOString() })
                        });
                    }

                    // Render UI
                    root.innerHTML = `
                        <div class="fade-enter pb-20">
                            <div class="flex items-center gap-2 mb-4 text-sm text-slate-500 cursor-pointer hover:text-orange-500" onclick="app.renderMyRecipes()">
                                <i class="fa-solid fa-arrow-left"></i> กลับ
                            </div>

                            <div class="bg-white rounded-3xl p-6 shadow-lg mb-6 relative overflow-hidden">
                                <div class="absolute -right-4 -top-4 w-24 h-24 bg-orange-100 rounded-full opacity-50"></div>
                                <h1 class="text-3xl font-bold text-slate-800 relative z-10">${d.name}</h1>
                                <div class="flex items-center gap-2 mt-2 text-sm text-slate-500 relative z-10">
                                    <i class="fa-regular fa-user"></i> โดย ${d.ownerName || 'ไม่ระบุ'}
                                </div>
                                <div class="mt-4 flex gap-2">
                                    <span class="badge badge-neutral font-mono">CODE: ${id}</span>
                                    <span class="badge bg-pink-100 text-pink-600 border-none"><i class="fa-solid fa-heart mr-1"></i> ${d.likes?.length||0}</span>
                                    <span class="badge bg-slate-100 text-slate-600 border-none"><i class="fa-solid fa-eye mr-1"></i> ${d.views?.length||0}</span>
                                </div>
                            </div>

                            <div class="grid md:grid-cols-3 gap-6">
                                <div class="md:col-span-1">
                                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100">
                                        <h3 class="font-bold text-lg text-orange-500 mb-3 border-b pb-2">วัตถุดิบ</h3>
                                        <ul class="space-y-2 text-sm">
                                            ${d.ingredients.map(i => `<li class="flex justify-between"><span>${i.name}</span> <span class="font-bold text-slate-600">${i.qty}</span></li>`).join('')}
                                        </ul>
                                    </div>
                                </div>
                                <div class="md:col-span-2">
                                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 min-h-[200px]">
                                        <h3 class="font-bold text-lg text-slate-700 mb-3 border-b pb-2">วิธีทำ</h3>
                                        <p class="whitespace-pre-line leading-loose text-slate-600 font-light">${d.steps}</p>
                                    </div>
                                    
                                    <div class="mt-6 flex justify-center gap-4">
                                        <button onclick="app.toggleLike('${id}')" class="btn btn-outline btn-error rounded-full gap-2 px-6">
                                            <i class="fa-regular fa-heart"></i> ถูกใจ
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                } catch(e) { Swal.fire('Error', e.message, 'error'); }
            },

            // --- Profile & Auth Logic ---
            openAuth: (mode) => {
                state.mode = mode;
                const m = document.getElementById('modal_auth');
                const title = document.getElementById('auth-title');
                const fields = document.getElementById('field-name');
                const switchTxt = document.getElementById('auth-toggle-text');
                
                document.getElementById('auth-form').reset();
                
                if(mode === 'login') {
                    title.innerText = "เข้าสู่ระบบ";
                    fields.classList.add('hidden');
                    switchTxt.innerText = "ยังไม่มีบัญชี? สมัครสมาชิก";
                } else {
                    title.innerText = "สมัครสมาชิก";
                    fields.classList.remove('hidden');
                    switchTxt.innerText = "มีบัญชีแล้ว? เข้าสู่ระบบ";
                }
                m.showModal();
            },

            toggleAuth: () => app.openAuth(state.mode === 'login' ? 'register' : 'login'),

            handleAuthSubmit: async (e) => {
                e.preventDefault();
                const email = document.getElementById('inp-email').value;
                const pass = document.getElementById('inp-pass').value;
                const name = document.getElementById('inp-name').value;
                const modal = document.getElementById('modal_auth');

                try {
                    if(state.mode === 'register') {
                        const res = await createUserWithEmailAndPassword(auth, email, pass);
                        await updateProfile(res.user, { displayName: name });
                        await setDoc(doc(db, "users", res.user.uid), { email, displayName: name });
                        Swal.fire({icon:'success', title: 'สมัครสำเร็จ', timer: 1500, showConfirmButton: false});
                    } else {
                        await signInWithEmailAndPassword(auth, email, pass);
                        Swal.fire({icon:'success', title: 'ยินดีต้อนรับ', timer: 1500, showConfirmButton: false});
                    }
                    modal.close();
                } catch(err) {
                    Swal.fire({icon:'error', title:'ผิดพลาด', text: err.message});
                }
            },

            openProfileModal: () => {
                document.getElementById('edit-name').value = state.user.displayName || '';
                document.getElementById('modal_profile').showModal();
            },

            saveProfile: async () => {
                const newName = document.getElementById('edit-name').value;
                if(!newName) return;
                try {
                    await updateProfile(state.user, { displayName: newName });
                    // Update in Firestore user collection too if needed
                    document.getElementById('modal_profile').close();
                    app.renderNav(); // Refresh UI
                    Swal.fire('สำเร็จ', 'อัปเดตข้อมูลแล้ว', 'success');
                } catch(e) { Swal.fire('Error', e.message, 'error'); }
            },

            logout: () => {
                Swal.fire({
                    title: 'ออกจากระบบ?',
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'ออกเลย',
                    cancelButtonText: 'ยกเลิก',
                    confirmButtonColor: '#d33'
                }).then(r => { if(r.isConfirmed) signOut(auth); });
            },

            // --- Recipe CRUD ---
            openCreateModal: () => {
                document.getElementById('recipe-name').value = '';
                document.getElementById('recipe-steps').value = '';
                document.getElementById('ing-list').innerHTML = '';
                app.addIng();
                document.getElementById('modal_create').showModal();
            },

            addIng: () => {
                const div = document.createElement('div');
                div.className = "flex gap-2 animate-fade-in-up";
                div.innerHTML = `
                    <input type="text" placeholder="วัตถุดิบ" class="input input-bordered w-full ing-name bg-slate-50">
                    <input type="text" placeholder="จำนวน" class="input input-bordered w-24 text-center ing-qty bg-slate-50">
                    <button onclick="this.parentElement.remove()" class="btn btn-square btn-ghost text-red-400"><i class="fa-solid fa-xmark"></i></button>
                `;
                document.getElementById('ing-list').appendChild(div);
            },

            saveRecipe: async () => {
                const name = document.getElementById('recipe-name').value;
                const steps = document.getElementById('recipe-steps').value;
                const ings = [];
                document.querySelectorAll('#ing-list > div').forEach(r => {
                    const n = r.querySelector('.ing-name').value;
                    const q = r.querySelector('.ing-qty').value;
                    if(n) ings.push({name: n, qty: q});
                });

                if(!name || ings.length === 0) return Swal.fire('ข้อมูลไม่ครบ', 'ใส่ชื่อและวัตถุดิบอย่างน้อย 1 อย่าง', 'warning');

                const code = Math.random().toString(36).substring(2, 7).toUpperCase();
                try {
                    Swal.showLoading();
                    await setDoc(doc(db, "recipes", code), {
                        name, steps, ingredients: ings,
                        ownerId: state.user.uid,
                        ownerName: state.user.displayName,
                        createdAt: serverTimestamp(),
                        views: [], likes: []
                    });
                    document.getElementById('modal_create').close();
                    Swal.fire('บันทึกสำเร็จ', `รหัสสูตร: ${code}`, 'success');
                    app.renderMyRecipes();
                } catch(e) { Swal.fire('Error', e.message, 'error'); }
            },

            deleteRecipe: (id) => {
                Swal.fire({
                    title: 'ลบสูตรนี้?',
                    text: 'ลบแล้วกู้คืนไม่ได้นะครับ',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    confirmButtonText: 'ลบ',
                    cancelButtonText: 'ไม่'
                }).then(async r => {
                    if(r.isConfirmed) {
                        await deleteDoc(doc(db, "recipes", id));
                        app.renderMyRecipes();
                    }
                })
            },
            
            toggleLike: async (id) => {
                const ref = doc(db, "recipes", id);
                const snap = await getDoc(ref);
                const likes = snap.data().likes || [];
                const uid = state.user.uid;
                
                if(likes.includes(uid)) await updateDoc(ref, { likes: arrayRemove(uid) });
                else await updateDoc(ref, { likes: arrayUnion(uid) });
                
                app.viewRecipeDetails(id); // Reload UI
            },

            copyCode: (code) => {
                navigator.clipboard.writeText(code);
                const Toast = Swal.mixin({toast: true, position: 'top-end', showConfirmButton: false, timer: 1500});
                Toast.fire({icon: 'success', title: 'คัดลอกรหัสแล้ว'});
            }
        };

        document.getElementById('auth-form').addEventListener('submit', app.handleAuthSubmit);
        app.init();
    </script>
</body>
</html>
